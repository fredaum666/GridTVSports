<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üì∫ TV Receiver - GridTV Sports</title>
    <link rel="icon" type="image/png" href="/assets/logo.png">
    <script src="/socket.io/socket.io.js"></script>
    <script src="/scripts/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e1a;
            color: #e0e0e0;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: clamp(10px, 2vmin, 30px);
        }

        .container {
            max-width: min(90vw, 600px);
            width: 100%;
            text-align: center;
        }

        h1 {
            font-size: clamp(2rem, 6vmin, 4rem);
            margin-bottom: clamp(0.5rem, 1.5vmin, 1.5rem);
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: clamp(1rem, 3vmin, 2rem);
            color: #94a3b8;
            margin-bottom: clamp(1.5rem, 4vmin, 4rem);
        }

        .pin-entry-section {
            background: #1a1f2e;
            border-radius: clamp(8px, 2vmin, 20px);
            padding: clamp(20px, 4vmin, 50px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid #334155;
        }

        .pin-entry-section h2 {
            font-size: clamp(1.2rem, 3.5vmin, 2.2rem);
            margin-bottom: clamp(0.5rem, 1.5vmin, 1.5rem);
            color: #fff;
        }

        .pin-entry-section p {
            color: #94a3b8;
            margin-bottom: clamp(1rem, 2.5vmin, 2.5rem);
            font-size: clamp(0.9rem, 2.2vmin, 1.4rem);
        }

        .pin-display-unified {
            background: #0f172a;
            border-radius: clamp(8px, 2vmin, 20px);
            padding: clamp(15px, 3vmin, 40px) clamp(25px, 5vmin, 60px);
            margin-bottom: clamp(1rem, 2.5vmin, 2.5rem);
            display: inline-block;
        }

        .pin-display-unified .pin-code {
            font-size: clamp(2rem, 8vmin, 5rem);
            font-weight: 700;
            letter-spacing: 0.3em;
            color: #6366f1;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .connect-btn {
            width: 100%;
            padding: clamp(12px, 2vmin, 20px);
            font-size: clamp(1rem, 2.5vmin, 1.5rem);
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: clamp(8px, 1.5vmin, 14px);
            cursor: pointer;
            transition: all 0.3s;
        }

        .connect-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .connect-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            margin-top: clamp(0.5rem, 1.5vmin, 1.5rem);
            padding: clamp(8px, 1.5vmin, 14px);
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 8px;
            color: #ef4444;
            font-size: clamp(0.8rem, 2vmin, 1.1rem);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .status-message {
            margin-top: clamp(0.5rem, 1.5vmin, 1.5rem);
            padding: clamp(8px, 1.5vmin, 14px);
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            border-radius: 8px;
            color: #22c55e;
            font-size: clamp(0.8rem, 2vmin, 1.1rem);
            display: none;
        }

        .status-message.show {
            display: block;
        }

        /* QR Code Authentication Section */
        .qr-auth-section {
            background: #1a1f2e;
            border-radius: clamp(8px, 2vmin, 20px);
            padding: clamp(20px, 4vmin, 50px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid #334155;
        }

        .qr-auth-section h2 {
            font-size: clamp(1.2rem, 3.5vmin, 2.2rem);
            margin-bottom: clamp(0.5rem, 1.5vmin, 1.5rem);
            color: #fff;
        }

        .qr-auth-section p {
            color: #94a3b8;
            margin-bottom: clamp(0.8rem, 2vmin, 2rem);
            font-size: clamp(0.9rem, 2.2vmin, 1.4rem);
        }

        .qr-container {
            background: #fff;
            border-radius: clamp(8px, 2vmin, 16px);
            padding: clamp(15px, 3vmin, 30px);
            display: inline-block;
            margin: clamp(1rem, 3vmin, 2rem) 0;
        }

        .qr-container canvas,
        .qr-container img {
            display: block;
            max-width: 100%;
            height: auto;
        }

        #qr-code {
            display: inline-block;
        }

        .qr-loading {
            width: clamp(150px, 25vmin, 250px);
            height: clamp(150px, 25vmin, 250px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6366f1;
            font-size: clamp(0.8rem, 2vmin, 1.2rem);
        }

        .qr-timer {
            color: #94a3b8;
            font-size: clamp(0.8rem, 2vmin, 1.1rem);
            margin-top: clamp(0.5rem, 1.5vmin, 1.5rem);
        }

        .qr-timer span:last-child {
            color: #6366f1;
            font-weight: 700;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .auth-success-banner {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid #22c55e;
            border-radius: clamp(8px, 1.5vmin, 12px);
            padding: clamp(12px, 2vmin, 20px);
            margin-bottom: clamp(1rem, 2.5vmin, 2.5rem);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(8px, 1.5vmin, 12px);
            color: #22c55e;
            font-size: clamp(0.9rem, 2vmin, 1.3rem);
            font-weight: 600;
        }

        .auth-success-banner .checkmark {
            width: clamp(24px, 4vmin, 36px);
            height: clamp(24px, 4vmin, 36px);
            background: #22c55e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: clamp(14px, 2.5vmin, 20px);
        }

        .user-email {
            color: #fff;
            font-weight: 400;
        }

        .sign-out-link {
            color: #6366f1;
            text-decoration: underline;
            cursor: pointer;
            font-size: clamp(0.7rem, 1.5vmin, 1rem);
            margin-left: clamp(8px, 1.5vmin, 15px);
        }

        .sign-out-link:hover {
            color: #8b5cf6;
        }

        .hidden {
            display: none !important;
        }

        /* Connected State */
        .tv-display {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            width: 100dvw;
            height: 100vh;
            height: 100dvh;
            background: #0a0e1a;
            z-index: 99999;
            overflow: hidden;
        }

        .tv-display.active {
            display: flex;
            flex-direction: column;
        }

        .tv-header {
            background: rgba(26, 31, 46, 0.95);
            padding: clamp(8px, 1.5vmin, 20px) clamp(15px, 3vmin, 40px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #334155;
            flex-shrink: 0;
        }

        .connected-indicator {
            display: flex;
            align-items: center;
            gap: clamp(6px, 1vmin, 12px);
            color: #22c55e;
            font-size: clamp(0.8rem, 2vmin, 1.3rem);
            font-weight: 600;
        }

        .pulse-dot {
            width: clamp(8px, 1.5vmin, 14px);
            height: clamp(8px, 1.5vmin, 14px);
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .device-name {
            color: #94a3b8;
            font-size: clamp(0.7rem, 1.8vmin, 1.1rem);
        }

        .fullscreen-grid {
            flex: 1;
            display: grid;
            gap: clamp(6px, 1.2vmin, 20px);
            padding: clamp(8px, 1.5vmin, 25px);
            overflow: hidden;
            height: calc(100vh - clamp(40px, 6vmin, 80px));
            height: calc(100dvh - clamp(40px, 6vmin, 80px));
            box-sizing: border-box;
        }

        .fullscreen-grid.grid-1 {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
            place-items: center;
            padding: clamp(10px, 2vmin, 40px);
        }

        .fullscreen-grid.grid-2 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: 1fr;
        }

        .fullscreen-grid.grid-4 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        .fullscreen-grid.grid-6 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        .fullscreen-grid.grid-8 {
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        .game-card {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            border-radius: clamp(6px, 1vmin, 16px);
            padding: clamp(8px, 1.5vmin, 30px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border: clamp(2px, 0.3vmin, 4px) solid #334155;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
            min-width: 0;
            min-height: 0;
        }

        .waiting-for-games {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(10px, 2vmin, 25px);
            color: #94a3b8;
            font-size: clamp(0.9rem, 2.5vmin, 1.4rem);
        }

        .waiting-for-games .spinner {
            width: clamp(30px, 6vmin, 70px);
            height: clamp(30px, 6vmin, 70px);
            border: clamp(2px, 0.5vmin, 5px) solid #334155;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }


        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(0.8rem, 2vmin, 1.2rem);
            color: #94a3b8;
        }

        /* Card State Styles */
        .game-card.winning-home,
        .game-card.winning-away {
            border-color: #22c55e;
            background: linear-gradient(135deg, #1a1f2e 0%, #1e3a2e 100%);
        }

        .game-card.tied {
            border-color: #fbbf24;
            background: linear-gradient(135deg, #1a1f2e 0%, #3a2e1e 100%);
        }

        .game-card.upcoming-game {
            border-color: #6366f1;
            background: linear-gradient(135deg, #1a1f2e 0%, #1e2a3a 100%);
            opacity: 0.95;
        }

        /* Fullscreen Layout Styles */
        .fullscreen-card-content {
            width: 100%;
            height: 100%;
            min-height: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: clamp(12px, 2.5vh, 40px);
            padding: clamp(10px, 2vmin, 30px);
            box-sizing: border-box;
            overflow: hidden;
        }

        .fullscreen-live-score-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(15px, 3vw, 40px);
            width: 100%;
            max-width: 95%;
            margin: 0 auto;
            flex-shrink: 1;
            min-height: 0;
        }

        .fullscreen-team-stack {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(3px, 1vh, 10px);
            position: relative;
            flex-shrink: 1;
            min-height: 0;
        }

        .fullscreen-team-logo {
            width: clamp(40px, 8vmin, 90px);
            height: clamp(40px, 8vmin, 90px);
            object-fit: contain;
            flex-shrink: 1;
        }

        .fullscreen-live-team-name {
            font-size: clamp(1.2rem, 3.5vmin, 2.5rem);
            font-weight: 700;
            color: #e5e7eb;
            line-height: 1.1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(6px, 1.2vw, 12px);
        }

        .fullscreen-live-team-name.winning {
            color: #10b981;
        }

        .fullscreen-team-record {
            font-size: clamp(0.7rem, 1.8vmin, 1.1rem);
            color: #9ca3af;
            font-weight: 600;
            text-align: center;
        }

        .fullscreen-team-score {
            font-size: clamp(2.5rem, 8vmin, 5rem);
            font-weight: 700;
            color: #e5e7eb;
            min-width: clamp(60px, 12vmin, 120px);
            text-align: center;
            line-height: 1;
        }

        .fullscreen-team-score.winning {
            color: #10b981;
        }

        .fullscreen-team-score.losing {
            color: #9ca3af;
        }

        .fullscreen-status-container {
            margin-bottom: clamp(5px, 1vh, 15px);
        }

        .fullscreen-status-text {
            font-size: clamp(0.9rem, 2.5vmin, 1.5rem);
            font-weight: 700;
            color: #17a2b8;
            text-transform: uppercase;
            text-align: center;
        }

        .fullscreen-vs-divider-live {
            font-size: clamp(0.9rem, 2.5vmin, 1.3rem);
            font-weight: 700;
            color: rgba(255, 255, 255, 0.5);
            padding: 0 clamp(5px, 1vw, 15px);
        }

        .fullscreen-upcoming-status-text {
            font-size: clamp(1rem, 3vmin, 1.8rem);
            font-weight: 700;
            color: #6366f1;
            margin-bottom: clamp(10px, 2vh, 20px);
            text-align: center;
        }

        .sport-logo-indicator {
            position: absolute;
            top: clamp(5px, 1vh, 15px);
            left: clamp(5px, 1vw, 15px);
            width: clamp(35px, 6vmin, 70px);
            height: clamp(35px, 6vmin, 70px);
            opacity: 0.7;
            object-fit: contain;
            z-index: 1;
        }

        @keyframes scoreUpdate {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
                color: #22c55e;
            }

            100% {
                transform: scale(1);
            }
        }

        /* Responsive adjustments for different TV sizes */

        /* Small screens (720p and below) */
        @media (max-height: 720px) {
            .fullscreen-grid {
                gap: clamp(4px, 0.8vmin, 12px);
                padding: clamp(4px, 1vmin, 15px);
            }

            .tv-header {
                padding: clamp(4px, 1vmin, 12px) clamp(8px, 2vmin, 20px);
            }

            .fullscreen-team-logo {
                width: clamp(25px, 6vmin, 50px);
                height: clamp(25px, 6vmin, 50px);
            }

            .fullscreen-team-score {
                font-size: clamp(1.5rem, 6vmin, 3rem);
                min-width: clamp(40px, 10vmin, 80px);
            }

            .fullscreen-live-team-name {
                font-size: clamp(0.8rem, 2.5vmin, 1.5rem);
            }

            .sport-logo-indicator {
                width: clamp(20px, 4vmin, 40px);
                height: clamp(20px, 4vmin, 40px);
            }
        }

        /* Large screens (4K) */
        @media (min-height: 1440px) {
            .fullscreen-grid {
                gap: clamp(15px, 1.5vmin, 30px);
                padding: clamp(20px, 2vmin, 40px);
            }

            .fullscreen-team-logo {
                width: clamp(80px, 10vmin, 150px);
                height: clamp(80px, 10vmin, 150px);
            }

            .fullscreen-team-score {
                font-size: clamp(4rem, 10vmin, 8rem);
            }
        }

        /* Landscape orientation optimization */
        @media (orientation: landscape) and (max-height: 600px) {
            .fullscreen-card-content {
                gap: clamp(5px, 1.5vmin, 20px);
                padding: clamp(5px, 1vmin, 15px);
            }

            .fullscreen-live-score-header {
                gap: clamp(8px, 2vw, 25px);
            }

            .fullscreen-team-stack {
                gap: clamp(2px, 0.5vmin, 6px);
            }

            .fullscreen-status-container {
                margin-bottom: clamp(2px, 0.5vmin, 8px);
            }
        }
    </style>
</head>

<body>
    <!-- QR Code Authentication Screen (shown first if not authenticated) -->
    <div id="qr-auth-display" class="container">
        <h1>üì∫</h1>
        <div class="subtitle">GridTV Sports - TV Receiver</div>

        <div class="qr-auth-section">
            <h2>Sign In to Your TV</h2>
            <p>Scan this QR code with your phone to sign in</p>

            <div class="qr-container">
                <div id="qr-code"></div>
                <div id="qr-loading" class="qr-loading">Generating QR code...</div>
            </div>

            <div class="qr-timer">
                <span>Code expires in: </span>
                <span id="qr-countdown">5:00</span>
            </div>

            <div class="error-message" id="qr-error-message"></div>
            <div class="status-message" id="qr-status-message"></div>
        </div>
    </div>

    <!-- PIN Display Screen (shown after authentication) -->
    <div id="pin-display" class="container hidden">
        <h1>üì∫</h1>
        <div class="subtitle">GridTV Sports - TV Receiver</div>

        <!-- Authenticated user banner -->
        <div class="auth-success-banner" id="auth-banner">
            <span class="checkmark">‚úì</span>
            <span>Signed in as <span class="user-email" id="user-email-display">user@email.com</span></span>
            <span class="sign-out-link" id="sign-out-btn">Sign Out</span>
        </div>

        <div class="pin-entry-section">
            <h2>Cast Your Games to This TV</h2>
            <p>Enter this code on your device:</p>

            <div class="pin-display-unified">
                <span class="pin-code" id="pin-code">------</span>
            </div>

            <p style="color: #94a3b8; font-size: clamp(0.8rem, 2vmin, 1.3rem); margin-top: clamp(1rem, 2.5vmin, 2.5rem);">
                On your device: LiveGames ‚Üí Click "üì∫ Cast to TV" ‚Üí Enter code above
            </p>

            <div class="error-message" id="error-message"></div>
            <div class="status-message" id="status-message"></div>
        </div>
    </div>

    <!-- TV Display Screen -->
    <div id="tv-display" class="tv-display">
        <div class="tv-header">
            <div class="connected-indicator">
                <div class="pulse-dot"></div>
                <span>Connected</span>
            </div>
            <div class="device-name" id="device-name">Control Device</div>
        </div>

        <div class="fullscreen-grid grid-2" id="fullscreen-grid">
            <div class="game-card waiting-for-games">
                <div class="spinner"></div>
                <div>Waiting for games to be selected...</div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // TV RECEIVER STATE
        // ============================================
        let socket = null;
        let sessionId = null;
        let refreshInterval = null;

        // QR Auth state
        let deviceId = null;
        let sessionToken = null;
        let qrToken = null;
        let qrCountdownInterval = null;
        let authCheckInterval = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        async function initTVReceiver() {
            // Generate or retrieve device ID from localStorage
            deviceId = localStorage.getItem('gridtv_device_id');
            if (!deviceId) {
                deviceId = crypto.randomUUID();
                localStorage.setItem('gridtv_device_id', deviceId);
            }
            console.log('Device ID:', deviceId.substring(0, 8) + '...');

            // Check for existing session
            sessionToken = localStorage.getItem('gridtv_session_token');
            if (sessionToken) {
                const valid = await validateExistingSession();
                if (valid) {
                    // Session is valid, go directly to PIN screen
                    showAuthenticatedState();
                    return;
                } else {
                    // Clear invalid session
                    localStorage.removeItem('gridtv_session_token');
                    sessionToken = null;
                }
            }

            // No valid session, show QR auth
            await generateQRCode();
            initSocketForAuth();
        }

        // ============================================
        // SESSION VALIDATION
        // ============================================
        async function validateExistingSession() {
            try {
                const response = await fetch('/api/tv/validate-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceId, sessionToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('user-email-display').textContent = data.userEmail || data.displayName || 'User';
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Session validation error:', error);
                return false;
            }
        }

        // ============================================
        // QR CODE GENERATION
        // ============================================
        let qrCodeInstance = null;

        async function generateQRCode() {
            const qrLoading = document.getElementById('qr-loading');
            const qrContainer = document.getElementById('qr-code');

            qrLoading.style.display = 'flex';
            qrContainer.style.display = 'none';

            try {
                const response = await fetch('/api/tv/generate-qr-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deviceId,
                        deviceName: 'GridTV Android TV'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    qrToken = data.token;

                    // Clear previous QR code
                    qrContainer.innerHTML = '';

                    // Generate QR code using qrcodejs library
                    const qrSize = Math.min(250, window.innerWidth * 0.4);
                    qrCodeInstance = new QRCode(qrContainer, {
                        text: data.authUrl,
                        width: qrSize,
                        height: qrSize,
                        colorDark: '#6366f1',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.M
                    });

                    qrLoading.style.display = 'none';
                    qrContainer.style.display = 'block';

                    // Start countdown
                    startQRCountdown(new Date(data.expiresAt));

                    // Start polling for auth status
                    startAuthPolling();

                    showQRStatus('Scan with your phone to sign in');
                } else {
                    showQRError('Failed to generate QR code. Retrying...');
                    setTimeout(generateQRCode, 5000);
                }
            } catch (error) {
                console.error('QR generation error:', error);
                showQRError('Connection error. Retrying...');
                setTimeout(generateQRCode, 5000);
            }
        }

        function startQRCountdown(expiresAt) {
            if (qrCountdownInterval) clearInterval(qrCountdownInterval);

            qrCountdownInterval = setInterval(() => {
                const now = new Date();
                const remaining = Math.max(0, expiresAt - now);
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);

                document.getElementById('qr-countdown').textContent =
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (remaining <= 0) {
                    clearInterval(qrCountdownInterval);
                    // Regenerate QR code
                    generateQRCode();
                }
            }, 1000);
        }

        // ============================================
        // SOCKET.IO FOR QR AUTH
        // ============================================
        function initSocketForAuth() {
            socket = io();

            socket.on('connect', () => {
                console.log('WebSocket connected for auth');
                // Register this socket for auth notifications
                if (qrToken) {
                    socket.emit('tv:register-for-auth', { token: qrToken }, (response) => {
                        if (response.success) {
                            console.log('Registered for auth notifications');
                        }
                    });
                }
            });

            // Listen for auth approval (real-time notification)
            socket.on('tv:auth-approved', (data) => {
                console.log('TV authenticated via Socket.IO!', data);
                sessionToken = data.sessionToken;
                localStorage.setItem('gridtv_session_token', sessionToken);

                document.getElementById('user-email-display').textContent =
                    data.userEmail || data.displayName || 'User';

                showAuthenticatedState();
            });

            socket.on('connect_error', (error) => {
                console.error('Socket connection error:', error);
            });
        }

        function startAuthPolling() {
            if (authCheckInterval) clearInterval(authCheckInterval);

            // Poll every 3 seconds as backup
            authCheckInterval = setInterval(() => {
                if (!qrToken || !socket) return;

                socket.emit('tv:check-auth-status', { token: qrToken }, (response) => {
                    if (response.success && response.status === 'approved') {
                        sessionToken = response.sessionToken;
                        localStorage.setItem('gridtv_session_token', sessionToken);

                        document.getElementById('user-email-display').textContent =
                            response.userEmail || response.displayName || 'User';

                        showAuthenticatedState();
                    }
                });
            }, 3000);
        }

        // ============================================
        // STATE TRANSITIONS
        // ============================================
        function showAuthenticatedState() {
            // Clear QR-related intervals
            if (qrCountdownInterval) clearInterval(qrCountdownInterval);
            if (authCheckInterval) clearInterval(authCheckInterval);

            // Hide QR screen, show PIN screen
            document.getElementById('qr-auth-display').classList.add('hidden');
            document.getElementById('pin-display').classList.remove('hidden');

            // Initialize casting system
            initCastingSystem();
        }

        function initCastingSystem() {
            // Initialize Socket.IO if not already connected
            if (!socket) {
                socket = io();
            }

            socket.on('connect', handleSocketConnect);

            // If already connected, trigger connect handler
            if (socket.connected) {
                handleSocketConnect();
            }

            // Set up casting event listeners
            socket.on('cast:receiver-connected', ({ deviceName }) => {
                console.log('Controller connected:', deviceName);

                // Switch to TV display mode
                document.getElementById('pin-display').classList.add('hidden');
                document.getElementById('tv-display').classList.add('active');
                document.getElementById('device-name').textContent = deviceName;

                // Start auto-refresh for live scores
                startAutoRefresh();
            });

            socket.on('cast:state-updated', ({ state }) => {
                console.log('State updated:', state);
                updateTVDisplay(state);
            });

            socket.on('cast:controller-disconnected', () => {
                showDisconnectedMessage();
            });

            socket.on('cast:session-ended', () => {
                console.log('Session ended');
                window.location.reload();
            });

            socket.on('cast:session-expired', () => {
                alert('Casting session expired');
                window.location.reload();
            });

            socket.on('disconnect', () => {
                console.log('Socket disconnected');
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                showError('Connection error. Please refresh the page.');
            });
        }

        function handleSocketConnect() {
            console.log('WebSocket connected for casting');

            // Create casting session
            socket.emit('cast:create-session', {
                deviceName: 'TV Receiver'
            }, (response) => {
                if (response.success) {
                    sessionId = response.sessionId;
                    const pin = response.pin;

                    console.log('Session created:', sessionId, 'PIN:', pin);

                    // Display PIN on screen
                    document.getElementById('pin-code').textContent = pin;
                    showStatus('‚úì Ready! Waiting for controller to connect...');
                } else {
                    showError('Failed to initialize TV. Please refresh the page.');
                }
            });
        }

        // ============================================
        // SIGN OUT
        // ============================================
        async function signOut() {
            try {
                await fetch('/api/tv/sign-out', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceId, sessionToken })
                });
            } catch (error) {
                console.error('Sign out error:', error);
            }

            // Clear local storage
            localStorage.removeItem('gridtv_session_token');
            sessionToken = null;

            // Reload page to show QR auth again
            window.location.reload();
        }

        // ============================================
        // UI HELPERS
        // ============================================
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        function showQRError(message) {
            const errorDiv = document.getElementById('qr-error-message');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        function showQRStatus(message) {
            const statusDiv = document.getElementById('qr-status-message');
            statusDiv.textContent = message;
            statusDiv.classList.add('show');
        }

        function showStatus(message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.classList.add('show');
        }

        function updateTVDisplay(state) {

            const grid = document.getElementById('fullscreen-grid');

            // Update grid layout
            grid.className = `fullscreen-grid grid-${state.layout || 2}`;

            // Clear existing content
            grid.innerHTML = '';

            // Check if games are selected (don't require isActive)
            if (!state.games || Object.keys(state.games).length === 0) {
                // Show waiting message
                const waitingCard = document.createElement('div');
                waitingCard.className = 'game-card waiting-for-games';
                waitingCard.innerHTML = `
          <div class="spinner"></div>
          <div>Waiting for games to be selected...</div>
        `;
                grid.appendChild(waitingCard);
                return;
            }

            // Render game cards (simplified for now, will be populated by auto-refresh)
            const slotCount = state.layout || 2;
            for (let i = 1; i <= slotCount; i++) {
                const gameId = state.games[`slot${i}`];
                const card = document.createElement('div');
                card.className = 'game-card';
                card.id = `game-slot-${i}`;
                card.innerHTML = `<div class="loading">Loading game data...</div>`;
                grid.appendChild(card);
            }

            // Trigger immediate refresh of game data
            refreshGameData(state);
        }

        async function refreshGameData(state) {
            if (!state || !state.games) {
                console.log('No state or games to refresh');
                return;
            }

            console.log('Refreshing game data with state:', state);

            // Store games globally for auto-refresh
            window.currentGames = state.games;

            // For each slot, fetch and display game data
            for (const [slot, gameId] of Object.entries(state.games)) {
                if (!gameId) continue;

                const slotNumber = slot.replace('slot', '');
                const cardElement = document.getElementById(`game-slot-${slotNumber}`);

                if (!cardElement) {
                    console.warn(`Card element not found for ${slot}`);
                    continue;
                }

                try {
                    // Extract sport and actual game ID
                    const parts = gameId.split(':');
                    if (parts.length !== 2) {
                        console.error(`Invalid game ID format: ${gameId}`);
                        cardElement.innerHTML = `<div style="color: #ef4444;">Invalid game ID format</div>`;
                        continue;
                    }

                    const [sport, actualGameId] = parts;
                    console.log(`Fetching ${sport} game ${actualGameId} for ${slot}`);

                    // Determine the correct API endpoint based on sport
                    let apiUrl;
                    if (sport === 'nfl' || sport === 'ncaa') {
                        // NFL and NCAA need week parameter
                        const weekResponse = await fetch(`/api/${sport}/current-week`);
                        const weekData = await weekResponse.json();
                        apiUrl = `/api/${sport}/scoreboard?week=${weekData.week}`;
                    } else {
                        // NBA, MLB, NHL use date-based scoreboard
                        apiUrl = `/api/${sport}/scoreboard`;
                    }

                    console.log(`Fetching from: ${apiUrl}`);
                    const response = await fetch(apiUrl);

                    if (!response.ok) {
                        throw new Error(`API returned ${response.status}`);
                    }

                    const data = await response.json();
                    console.log(`API response for ${sport}:`, data);

                    // Find the specific game - check both data.games and data.events
                    const games = data.games || data.events || [];
                    const game = games.find(g => g.id === actualGameId);

                    if (game) {
                        console.log(`Found game:`, game);
                        cardElement.innerHTML = renderGameCard(game, sport);
                    } else {
                        console.warn(`Game ${actualGameId} not found in API response`);
                        cardElement.innerHTML = `<div style="color: #94a3b8; text-align: center;">Game not found</div>`;
                    }
                } catch (error) {
                    console.error(`Error fetching game ${gameId}:`, error);
                    cardElement.innerHTML = `<div style="color: #ef4444; text-align: center;">Error: ${error.message}</div>`;
                }
            }
        }


        function renderGameCard(game, sport) {
            console.log('Rendering game card for:', game);

            // Get competition data
            const comp = game.competitions?.[0];
            if (!comp) {
                return '<div style="color: #ef4444;">No competition data</div>';
            }

            // Get competitors (index 1 = away, index 0 = home for ESPN API)
            const awayTeam = comp.competitors?.[1];
            const homeTeam = comp.competitors?.[0];

            if (!awayTeam || !homeTeam) {
                return '<div style="color: #ef4444;">Missing team data</div>';
            }

            // Extract team data
            const awayLogo = awayTeam.team?.logo || '';
            const homeLogo = homeTeam.team?.logo || '';
            const awayName = awayTeam.team?.abbreviation || awayTeam.team?.shortDisplayName || 'AWAY';
            const homeName = homeTeam.team?.abbreviation || homeTeam.team?.shortDisplayName || 'HOME';
            const awayScore = parseInt(awayTeam.score || 0);
            const homeScore = parseInt(homeTeam.score || 0);
            const awayRecord = awayTeam.records?.[0]?.summary || '';
            const homeRecord = homeTeam.records?.[0]?.summary || '';

            // Get game status
            const statusState = comp.status?.type?.state || 'pre';
            const isFinal = statusState === 'post';
            const isLive = (statusState === 'in' || comp.status?.period > 0) && !isFinal;
            const isUpcoming = statusState === 'pre' && !isFinal;

            const statusDisplay = comp.status?.type?.shortDetail || comp.status?.type?.detail || 'Scheduled';

            // Sport logo mapping
            const sportLogos = {
                nfl: '/assets/NFL-logo.png',
                ncaa: '/assets/NCAA logo.png',
                nba: '/assets/NBA-logo.png',
                mlb: '/assets/MLB-logo.png',
                nhl: '/assets/NHL-logo.png'
            };
            const sportLogo = sportLogos[sport.toLowerCase()] || '/assets/logo.png';

            // Possession indicators
            const possession = comp.situation?.possession;
            const awayHasBall = possession === awayTeam.id;
            const homeHasBall = possession === homeTeam.id;
            const possessionIcon = sport === 'nba' ? 'üèÄ' : sport === 'nhl' ? 'üèí' : 'üèà';

            return `
                <div class="fullscreen-card-content">
                    <img src="${sportLogo}" alt="${sport.toUpperCase()}" class="sport-logo-indicator">
                    
                    ${isUpcoming ? `
                        <!-- Upcoming Game -->
                        <div class="fullscreen-upcoming-status-text">‚è∞ ${statusDisplay}</div>
                        <div class="fullscreen-live-score-header">
                            <div class="fullscreen-team-stack">
                                ${awayLogo ? `<img src="${awayLogo}" alt="${awayName}" class="fullscreen-team-logo">` : ''}
                                <div class="fullscreen-live-team-name">${awayName}</div>
                                ${awayRecord ? `<div class="fullscreen-team-record">${awayRecord}</div>` : ''}
                            </div>
                            <div class="fullscreen-team-score">-</div>
                            <div class="fullscreen-vs-divider-live">VS</div>
                            <div class="fullscreen-team-score">-</div>
                            <div class="fullscreen-team-stack">
                                ${homeLogo ? `<img src="${homeLogo}" alt="${homeName}" class="fullscreen-team-logo">` : ''}
                                <div class="fullscreen-live-team-name">${homeName}</div>
                                ${homeRecord ? `<div class="fullscreen-team-record">${homeRecord}</div>` : ''}
                            </div>
                        </div>
                    ` : `
                        <!-- Live or Final Game -->
                        <div class="fullscreen-status-container">
                            <div class="fullscreen-status-text">${statusDisplay}</div>
                        </div>
                        
                        <div class="fullscreen-live-score-header">
                            <div class="fullscreen-team-stack">
                                ${awayLogo ? `<img src="${awayLogo}" alt="${awayName}" class="fullscreen-team-logo"  onerror="this.style.display='none'">` : ''}
                                <div class="fullscreen-live-team-name ${awayScore > homeScore ? 'winning' : ''}">${awayName}${awayHasBall && (sport === 'nfl' || sport === 'ncaa' || sport === 'nba') ? ` ${possessionIcon}` : ''}</div>
                                ${awayRecord ? `<div class="fullscreen-team-record">${awayRecord}</div>` : ''}
                            </div>
                            <div class="fullscreen-team-score ${awayScore > homeScore ? 'winning' : 'losing'}">${awayScore}</div>
                            
                            <div class="fullscreen-vs-divider-live">VS</div>
                            
                            <div class="fullscreen-team-score ${homeScore > awayScore ? 'winning' : 'losing'}">${homeScore}</div>
                            <div class="fullscreen-team-stack">
                                ${homeLogo ? `<img src="${homeLogo}" alt="${homeName}" class="fullscreen-team-logo" onerror="this.style.display='none'">` : ''}
                                <div class="fullscreen-live-team-name ${homeScore > awayScore ? 'winning' : ''}">${homeName}${homeHasBall && (sport === 'nfl' || sport === 'ncaa' || sport === 'nba') ? ` ${possessionIcon}` : ''}</div>
                                ${homeRecord ? `<div class="fullscreen-team-record">${homeRecord}</div>` : ''}
                            </div>
                        </div>
                    `}
                </div>
            `;
        }



        function startAutoRefresh() {
            // Refresh every 15 seconds
            refreshInterval = setInterval(() => {
                if (sessionId && socket?.connected) {
                    // Get current state from the grid
                    const grid = document.getElementById('fullscreen-grid');
                    const layoutMatch = grid.className.match(/grid-(\d+)/);
                    const layout = layoutMatch ? parseInt(layoutMatch[1]) : 2;

                    // Refresh with mock state - in production this would come from controller
                    refreshGameData({
                        layout,
                        games: window.currentGames || {},
                        isActive: true
                    });
                }
            }, 15000);
        }

        function showDisconnectedMessage() {
            const grid = document.getElementById('fullscreen-grid');
            grid.innerHTML = `
        <div class="game-card waiting-for-games">
          <div style="font-size: 2rem; color: #ef4444; margin-bottom: 1rem;">‚ö†Ô∏è</div>
          <div style="font-size: 1.5rem; color: #ef4444;">Controller Disconnected</div>
          <div style="margin-top: 1rem; color: #94a3b8;">Waiting for reconnection...</div>
        </div>
      `;

            // Stop auto-refresh
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Initialize TV receiver on page load
        window.addEventListener('DOMContentLoaded', () => {
            initTVReceiver();

            // Set up sign out button
            document.getElementById('sign-out-btn').addEventListener('click', signOut);
        });

        // Store current games globally for refresh
        window.currentGames = {};
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mission Control - GridTV Sports</title>
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      /* Deep Space Blacks */
      --bg-void: #05070a;
      --bg-panel: #0a0e14;
      --bg-surface: #0f141c;
      --bg-elevated: #151c27;
      --bg-hover: #1a2332;

      /* Luminous Telemetry Colors */
      --signal-blue: #00d4ff;
      --signal-green: #00ff88;
      --signal-amber: #ffb800;
      --signal-red: #ff3366;
      --signal-purple: #a855f7;
      --signal-orange: #ff6b35;

      /* Text Colors */
      --text-bright: #f0f4f8;
      --text-primary: #c9d1d9;
      --text-dim: #6b7a8f;
      --text-muted: #3d4a5c;

      /* Borders */
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-active: rgba(0, 212, 255, 0.4);

      /* Glows */
      --glow-blue: 0 0 20px rgba(0, 212, 255, 0.3);
      --glow-green: 0 0 20px rgba(0, 255, 136, 0.3);
      --glow-red: 0 0 20px rgba(255, 51, 102, 0.3);
      --glow-amber: 0 0 20px rgba(255, 184, 0, 0.3);
      --glow-purple: 0 0 20px rgba(168, 85, 247, 0.3);

      /* Timing */
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes scanline {
      0%, 100% { transform: translateX(-100%); opacity: 0; }
      50% { transform: translateX(100%); opacity: 1; }
    }

    @keyframes pulse-ring {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(2.5); opacity: 0; }
    }

    @keyframes glow-pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    @keyframes slide-up {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slide-in-right {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slide-in-left {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes value-bump {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    @keyframes progress-fill {
      from { transform: scaleX(0); }
      to { transform: scaleX(1); }
    }

    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    body {
      font-family: 'Space Grotesk', -apple-system, sans-serif;
      background: var(--bg-void);
      color: var(--text-primary);
      min-height: 100vh;
      font-size: 13px;
      line-height: 1.5;
      overflow: hidden;
    }

    /* ========== HEADER ========== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      height: 60px;
      background: linear-gradient(180deg, var(--bg-panel) 0%, var(--bg-void) 100%);
      border-bottom: 1px solid var(--border-subtle);
      position: relative;
      z-index: 100;
      animation: fade-in 0.4s var(--ease-out-expo);
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent 0%, var(--signal-blue) 50%, transparent 100%);
      opacity: 0.8;
    }

    .header::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
      animation: scanline 4s ease-in-out infinite;
      opacity: 0.3;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-container {
      position: relative;
      width: 36px;
      height: 36px;
    }

    .logo {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      position: relative;
      z-index: 1;
    }

    .logo-glow {
      position: absolute;
      inset: -4px;
      background: radial-gradient(circle, rgba(0, 212, 255, 0.3) 0%, transparent 70%);
      border-radius: 12px;
      animation: glow-pulse 3s ease-in-out infinite;
    }

    .title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 15px;
      font-weight: 700;
      color: var(--text-bright);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .subtitle {
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .badge-admin {
      background: linear-gradient(135deg, var(--signal-red), #cc2952);
      color: #fff;
      box-shadow: var(--glow-red);
    }

    .header-center {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .monitoring-status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
    }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .live-dot-container {
      position: relative;
      width: 10px;
      height: 10px;
    }

    .live-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--signal-green);
      position: relative;
      z-index: 1;
    }

    .live-dot::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: var(--signal-green);
      animation: pulse-ring 2s ease-out infinite;
    }

    .monitoring-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 600;
      color: var(--signal-green);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .monitoring-game {
      font-size: 12px;
      color: var(--text-dim);
      padding-left: 12px;
      border-left: 1px solid var(--border-subtle);
    }

    .refresh-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 140px;
    }

    .refresh-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      justify-content: space-between;
    }

    .refresh-bar {
      height: 3px;
      background: var(--bg-elevated);
      border-radius: 2px;
      overflow: hidden;
    }

    .refresh-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--signal-blue), var(--signal-green));
      border-radius: 2px;
      transform-origin: left;
      animation: progress-fill 20s linear infinite;
      box-shadow: 0 0 10px var(--signal-blue);
    }

    .header-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      background: var(--bg-surface);
      color: var(--text-primary);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s var(--ease-out-expo);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .btn:hover {
      background: var(--bg-elevated);
      border-color: var(--border-active);
      transform: translateY(-1px);
    }

    .btn:hover::before {
      opacity: 1;
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-icon {
      width: 40px;
      padding: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--signal-blue), #0099cc);
      border-color: var(--signal-blue);
      color: #fff;
      box-shadow: var(--glow-blue);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #00e5ff, var(--signal-blue));
      box-shadow: 0 0 30px rgba(0, 212, 255, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--signal-green), #00cc6a);
      border-color: var(--signal-green);
      color: #000;
      font-weight: 700;
    }

    .btn-success:hover {
      box-shadow: var(--glow-green);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--signal-red), #cc2952);
      border-color: var(--signal-red);
      color: #fff;
    }

    .btn-danger:hover {
      box-shadow: var(--glow-red);
    }

    .btn svg {
      width: 16px;
      height: 16px;
    }

    /* ========== MAIN CONTAINER ========== */
    .container {
      display: grid;
      grid-template-columns: 300px 1fr;
      height: calc(100vh - 60px);
    }

    /* ========== SIDEBAR ========== */
    .sidebar {
      background: var(--bg-panel);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: slide-in-left 0.5s var(--ease-out-expo) 0.1s both;
    }

    .sidebar-section {
      padding: 16px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .section-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      text-transform: uppercase;
      color: var(--text-dim);
      font-weight: 600;
      letter-spacing: 1.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title::before {
      content: '';
      width: 3px;
      height: 12px;
      background: var(--signal-blue);
      border-radius: 2px;
    }

    .league-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .league-tab {
      padding: 10px 8px;
      border-radius: 6px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      color: var(--text-dim);
      cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      transition: all 0.2s var(--ease-out-expo);
      position: relative;
      overflow: hidden;
    }

    .league-tab::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 2px;
      background: var(--signal-blue);
      transition: all 0.3s var(--ease-out-expo);
      transform: translateX(-50%);
    }

    .league-tab:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border-color: var(--border-active);
    }

    .league-tab:hover::before {
      width: 50%;
    }

    .league-tab.active {
      background: rgba(0, 212, 255, 0.1);
      border-color: var(--signal-blue);
      color: var(--signal-blue);
      box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.1);
    }

    .league-tab.active::before {
      width: 80%;
      box-shadow: 0 0 10px var(--signal-blue);
    }

    .game-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .game-list::-webkit-scrollbar {
      width: 6px;
    }

    .game-list::-webkit-scrollbar-track {
      background: var(--bg-void);
    }

    .game-list::-webkit-scrollbar-thumb {
      background: var(--bg-elevated);
      border-radius: 3px;
    }

    .game-list::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    .game-item {
      position: relative;
      padding: 14px 16px;
      border-radius: 10px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      cursor: pointer;
      transition: all 0.25s var(--ease-out-expo);
      overflow: hidden;
    }

    .game-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--game-status-color, var(--text-muted));
      transition: all 0.25s var(--ease-out-expo);
    }

    .game-item:hover {
      background: var(--bg-hover);
      border-color: var(--border-active);
      transform: translateX(4px);
    }

    .game-item:hover::before {
      width: 4px;
      box-shadow: 0 0 15px var(--game-status-color, var(--text-muted));
    }

    .game-item.active {
      background: rgba(0, 212, 255, 0.08);
      border-color: var(--signal-blue);
    }

    .game-item.active::before {
      width: 4px;
      background: var(--signal-blue);
      box-shadow: var(--glow-blue);
    }

    .game-item.live {
      --game-status-color: var(--signal-green);
    }

    .game-item.pre {
      --game-status-color: var(--signal-amber);
    }

    .game-item.post {
      --game-status-color: var(--text-muted);
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .game-teams {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-bright);
    }

    .game-status {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .game-status.live {
      background: var(--signal-green);
      color: #000;
      box-shadow: var(--glow-green);
    }

    .game-status.pre {
      background: var(--signal-amber);
      color: #000;
    }

    .game-status.post {
      background: var(--text-muted);
      color: var(--text-bright);
    }

    .game-score {
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    .game-progress {
      height: 3px;
      background: var(--bg-elevated);
      border-radius: 2px;
      overflow: hidden;
    }

    .game-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--signal-green), var(--signal-blue));
      border-radius: 2px;
      transition: width 0.5s var(--ease-out-expo);
    }

    .no-games {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-dim);
      text-align: center;
      gap: 12px;
    }

    .no-games svg {
      width: 48px;
      height: 48px;
      opacity: 0.3;
    }

    /* ========== MAIN CONTENT ========== */
    .main-content {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: slide-up 0.5s var(--ease-out-expo) 0.2s both;
    }

    /* ========== STATS GRID ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      padding: 16px 20px;
      background: linear-gradient(180deg, var(--bg-panel) 0%, var(--bg-void) 100%);
      border-bottom: 1px solid var(--border-subtle);
    }

    .stat-box {
      position: relative;
      background: var(--bg-surface);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      padding: 16px 20px;
      overflow: hidden;
      transition: all 0.3s var(--ease-out-expo);
    }

    .stat-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--stat-color);
    }

    .stat-box::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 0;
      right: 0;
      height: 30px;
      background: linear-gradient(180deg, var(--stat-color), transparent);
      opacity: 0.1;
    }

    .stat-box:hover {
      transform: translateY(-2px);
      border-color: var(--stat-color);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .stat-box.api { --stat-color: var(--signal-blue); }
    .stat-box.plays { --stat-color: var(--signal-green); }
    .stat-box.animations { --stat-color: var(--signal-amber); }
    .stat-box.errors { --stat-color: var(--signal-red); }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .stat-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .stat-rate {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--stat-color);
      opacity: 0.8;
    }

    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 32px;
      font-weight: 700;
      color: var(--stat-color);
      text-shadow: 0 0 30px var(--stat-color);
      line-height: 1;
      transition: transform 0.15s var(--ease-out-back);
    }

    .stat-value.bump {
      animation: value-bump 0.3s var(--ease-out-back);
    }

    .sparkline {
      display: flex;
      align-items: flex-end;
      gap: 3px;
      height: 24px;
      margin-top: 12px;
    }

    .sparkline-bar {
      flex: 1;
      background: var(--stat-color);
      border-radius: 2px;
      opacity: 0.4;
      transition: all 0.3s var(--ease-out-expo);
      min-height: 2px;
    }

    .sparkline-bar:last-child {
      opacity: 0.8;
    }

    /* ========== TABS BAR ========== */
    .tabs-bar {
      display: flex;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-subtle);
      padding: 0 20px;
      position: relative;
    }

    .tab-indicator {
      position: absolute;
      bottom: 0;
      height: 2px;
      background: var(--signal-blue);
      box-shadow: 0 0 15px var(--signal-blue);
      transition: all 0.3s var(--ease-out-expo);
      border-radius: 2px 2px 0 0;
    }

    .tab {
      padding: 16px 24px;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s var(--ease-out-expo);
      position: relative;
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      color: var(--signal-blue);
    }

    /* ========== FILTER BAR ========== */
    .filter-bar {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border-subtle);
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.2s var(--ease-out-expo);
      color: var(--text-dim);
    }

    .filter-chip:hover {
      background: var(--bg-elevated);
      border-color: var(--border-active);
      color: var(--text-primary);
    }

    .filter-chip.active {
      background: rgba(0, 212, 255, 0.15);
      border-color: var(--signal-blue);
      color: var(--signal-blue);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.15);
    }

    .filter-chip.active.api {
      --filter-color: var(--signal-blue);
      background: rgba(0, 212, 255, 0.15);
      border-color: var(--signal-blue);
      color: var(--signal-blue);
    }
    .filter-chip.active.play {
      --filter-color: var(--signal-green);
      background: rgba(0, 255, 136, 0.15);
      border-color: var(--signal-green);
      color: var(--signal-green);
    }
    .filter-chip.active.animation {
      --filter-color: var(--signal-purple);
      background: rgba(168, 85, 247, 0.15);
      border-color: var(--signal-purple);
      color: var(--signal-purple);
    }
    .filter-chip.active.cache {
      --filter-color: var(--signal-amber);
      background: rgba(255, 184, 0, 0.15);
      border-color: var(--signal-amber);
      color: var(--signal-amber);
    }
    .filter-chip.active.state {
      --filter-color: var(--signal-orange);
      background: rgba(255, 107, 53, 0.15);
      border-color: var(--signal-orange);
      color: var(--signal-orange);
    }
    .filter-chip.active.error {
      --filter-color: var(--signal-red);
      background: rgba(255, 51, 102, 0.15);
      border-color: var(--signal-red);
      color: var(--signal-red);
    }

    .filter-badge {
      background: currentColor;
      color: #000;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 700;
      min-width: 18px;
      text-align: center;
    }

    .filter-spacer {
      flex: 1;
    }

    /* ========== TAB CONTENT ========== */
    .tab-content {
      flex: 1;
      overflow: hidden;
      display: none;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* ========== LOG CONTAINER ========== */
    .log-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }

    .log-container::-webkit-scrollbar {
      width: 8px;
    }

    .log-container::-webkit-scrollbar-track {
      background: var(--bg-void);
    }

    .log-container::-webkit-scrollbar-thumb {
      background: var(--bg-elevated);
      border-radius: 4px;
    }

    .log-entry {
      display: grid;
      grid-template-columns: 80px 70px 1fr;
      gap: 16px;
      padding: 12px 16px;
      background: var(--bg-surface);
      border-radius: 8px;
      border-left: 3px solid var(--log-color, var(--text-muted));
      margin-bottom: 8px;
      transition: all 0.2s var(--ease-out-expo);
      animation: slide-in-right 0.3s var(--ease-out-expo);
    }

    .log-entry:hover {
      background: var(--bg-elevated);
      transform: translateX(4px);
    }

    .log-entry.api { --log-color: var(--signal-blue); }
    .log-entry.play { --log-color: var(--signal-green); }
    .log-entry.animation { --log-color: var(--signal-purple); }
    .log-entry.cache { --log-color: var(--signal-amber); }
    .log-entry.error {
      --log-color: var(--signal-red);
      background: rgba(255, 51, 102, 0.08);
    }
    .log-entry.state { --log-color: var(--signal-orange); }

    .log-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
      padding-top: 2px;
    }

    .log-type-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 4px 10px;
      border-radius: 4px;
      background: var(--log-color);
      color: #000;
      text-align: center;
      height: fit-content;
    }

    .log-entry.cache .log-type-badge,
    .log-entry.state .log-type-badge {
      color: #000;
    }

    .log-entry.api .log-type-badge,
    .log-entry.play .log-type-badge,
    .log-entry.animation .log-type-badge,
    .log-entry.error .log-type-badge {
      color: #fff;
    }

    .log-message {
      font-size: 13px;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .log-connector {
      color: var(--text-muted);
      margin-right: 8px;
      font-family: 'JetBrains Mono', monospace;
    }

    .log-details {
      margin-top: 10px;
      padding: 12px;
      background: var(--bg-void);
      border-radius: 6px;
      border: 1px solid var(--border-subtle);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      line-height: 1.6;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      color: var(--text-dim);
    }

    .log-details .json-key { color: var(--signal-purple); }
    .log-details .json-string { color: var(--signal-green); }
    .log-details .json-number { color: var(--signal-amber); }

    .no-logs {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: var(--text-dim);
      text-align: center;
      gap: 16px;
    }

    .no-logs svg {
      width: 64px;
      height: 64px;
      opacity: 0.2;
    }

    .no-logs-text {
      font-size: 14px;
    }

    .no-logs-hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ========== STATE PANEL ========== */
    .state-panel {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      padding: 20px;
      overflow-y: auto;
    }

    .state-card {
      background: var(--bg-surface);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      transition: all 0.3s var(--ease-out-expo);
    }

    .state-card:hover {
      border-color: var(--border-active);
    }

    .state-card.full-width {
      grid-column: span 2;
    }

    .state-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border-subtle);
    }

    .state-card-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .state-card-title::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--signal-blue);
      border-radius: 2px;
    }

    .state-card-header .btn {
      padding: 6px 12px;
      font-size: 10px;
    }

    .state-card-body {
      padding: 16px 18px;
      max-height: 320px;
      overflow-y: auto;
    }

    .state-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .state-item:last-child {
      border-bottom: none;
    }

    .state-key {
      color: var(--text-muted);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .state-key::after {
      content: '';
      flex: 1;
      border-bottom: 1px dotted var(--border-subtle);
      min-width: 20px;
    }

    .state-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--signal-blue);
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }

    .state-value.success { color: var(--signal-green); }
    .state-value.warning { color: var(--signal-amber); }
    .state-value.error { color: var(--signal-red); }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-dot.green { background: var(--signal-green); box-shadow: var(--glow-green); }
    .status-dot.amber { background: var(--signal-amber); box-shadow: var(--glow-amber); }
    .status-dot.red { background: var(--signal-red); box-shadow: var(--glow-red); }

    .progress-bar-container {
      margin-top: 12px;
    }

    .progress-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 6px;
    }

    .progress-bar {
      height: 6px;
      background: var(--bg-void);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s var(--ease-out-expo);
    }

    .progress-bar-fill.success { background: linear-gradient(90deg, var(--signal-green), var(--signal-blue)); }
    .progress-bar-fill.error { background: var(--signal-red); }

    .json-viewer {
      background: var(--bg-void);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      padding: 14px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      line-height: 1.6;
      max-height: 180px;
      overflow: auto;
      white-space: pre-wrap;
      color: var(--text-dim);
      margin-top: 12px;
    }

    /* ========== API RESPONSE PANEL ========== */
    .api-response-panel {
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 16px;
      overflow-y: auto;
    }

    /* ========== EXPORT MODAL ========== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s var(--ease-out-expo);
    }

    .modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--bg-panel);
      border: 2px solid var(--signal-blue);
      border-radius: 16px;
      box-shadow: 0 0 60px rgba(0, 212, 255, 0.2),
                  0 30px 80px rgba(0, 0, 0, 0.6);
      max-width: 900px;
      width: 95%;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      transform: scale(0.9) translateY(20px);
      transition: all 0.4s var(--ease-out-expo);
    }

    .modal-backdrop.show .modal-content {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      padding: 24px 28px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .modal-title-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 18px;
      font-weight: 700;
      color: var(--signal-blue);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-title svg {
      width: 24px;
      height: 24px;
    }

    .modal-subtitle {
      font-size: 13px;
      color: var(--text-dim);
    }

    .modal-close {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-surface);
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--signal-red);
      border-color: var(--signal-red);
      color: #fff;
    }

    .modal-close svg {
      width: 18px;
      height: 18px;
    }

    .modal-body {
      padding: 24px 28px;
      flex: 1;
      overflow-y: auto;
    }

    .export-info {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .export-info-item {
      background: var(--bg-surface);
      border-radius: 8px;
      padding: 14px 16px;
      border: 1px solid var(--border-subtle);
    }

    .export-info-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .export-info-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      color: var(--text-bright);
    }

    .export-textarea {
      width: 100%;
      height: 350px;
      background: var(--bg-void);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      line-height: 1.6;
      padding: 16px;
      resize: vertical;
    }

    .export-textarea:focus {
      outline: none;
      border-color: var(--signal-blue);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    .modal-footer {
      padding: 20px 28px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn-action {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 14px 24px;
      font-size: 13px;
      font-weight: 600;
    }

    .btn-action svg {
      width: 18px;
      height: 18px;
    }

    .btn-action.success {
      background: linear-gradient(135deg, var(--signal-green), #00cc6a) !important;
      border-color: var(--signal-green) !important;
      color: #000 !important;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .state-panel {
        grid-template-columns: 1fr;
      }

      .state-card.full-width {
        grid-column: span 1;
      }
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }

      .sidebar {
        display: none;
      }

      .monitoring-status {
        display: none;
      }

      .header-center {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <div class="logo-container">
        <div class="logo-glow"></div>
        <img src="/assets/logo.png" alt="GridTV" class="logo">
      </div>
      <div class="title-group">
        <span class="title">Mission Control</span>
        <span class="subtitle">Debug Console</span>
      </div>
      <span class="badge badge-admin">Admin</span>
    </div>

    <div class="header-center">
      <div class="monitoring-status" id="monitoring-status" style="display: none;">
        <div class="live-indicator">
          <div class="live-dot-container">
            <span class="live-dot"></span>
          </div>
          <span class="monitoring-text">Live</span>
        </div>
        <span class="monitoring-game" id="monitoring-game">-</span>
      </div>

      <div class="refresh-container">
        <div class="refresh-text">
          <span>Auto-refresh</span>
          <span id="refresh-countdown">20s</span>
        </div>
        <div class="refresh-bar">
          <div class="refresh-progress" id="refresh-progress"></div>
        </div>
      </div>
    </div>

    <div class="header-controls">
      <button class="btn" id="toggle-refresh" title="Pause/Resume">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span>Pause</span>
      </button>
      <button class="btn btn-success" id="export-btn">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
        <span>Export</span>
      </button>
      <button class="btn" onclick="window.location.href='/'">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
        <span>Back</span>
      </button>
    </div>
  </div>

  <div class="container">
    <div class="sidebar">
      <div class="sidebar-section">
        <div class="section-header">
          <div class="section-title">Leagues</div>
        </div>
        <div class="league-grid">
          <button class="league-tab active" data-league="nfl">NFL</button>
          <button class="league-tab" data-league="ncaa">NCAAF</button>
          <button class="league-tab" data-league="nba">NBA</button>
          <button class="league-tab" data-league="nhl">NHL</button>
          <button class="league-tab" data-league="mlb">MLB</button>
          <button class="league-tab" data-league="ncaab">NCAAB</button>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="section-header">
          <div class="section-title">Games</div>
        </div>
        <button class="btn btn-primary" id="fetch-games" style="width: 100%;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          <span>Fetch Games</span>
        </button>
      </div>

      <div class="game-list" id="game-list">
        <div class="no-games">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
          <span>Click "Fetch Games" to load</span>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="stats-grid" id="stats-grid">
        <div class="stat-box api">
          <div class="stat-header">
            <span class="stat-label">API Calls</span>
            <span class="stat-rate" id="stat-api-rate">+0/min</span>
          </div>
          <div class="stat-value" id="stat-api">0</div>
          <div class="sparkline" id="sparkline-api"></div>
        </div>
        <div class="stat-box plays">
          <div class="stat-header">
            <span class="stat-label">Play Events</span>
            <span class="stat-rate" id="stat-plays-rate">+0/min</span>
          </div>
          <div class="stat-value" id="stat-plays">0</div>
          <div class="sparkline" id="sparkline-plays"></div>
        </div>
        <div class="stat-box animations">
          <div class="stat-header">
            <span class="stat-label">Animations</span>
            <span class="stat-rate" id="stat-anim-rate">+0/min</span>
          </div>
          <div class="stat-value" id="stat-animations">0</div>
          <div class="sparkline" id="sparkline-anim"></div>
        </div>
        <div class="stat-box errors">
          <div class="stat-header">
            <span class="stat-label">Errors</span>
            <span class="stat-rate" id="stat-errors-rate">+0/min</span>
          </div>
          <div class="stat-value" id="stat-errors">0</div>
          <div class="sparkline" id="sparkline-errors"></div>
        </div>
      </div>

      <div class="tabs-bar">
        <div class="tab active" data-tab="logs">All Logs</div>
        <div class="tab" data-tab="plays">Play-by-Play</div>
        <div class="tab" data-tab="api">API Responses</div>
        <div class="tab" data-tab="state">App State</div>
        <div class="tab-indicator" id="tab-indicator"></div>
      </div>

      <div class="filter-bar" id="filter-bar">
        <button class="filter-chip active" data-filter="all">All</button>
        <button class="filter-chip api" data-filter="api">API <span class="filter-badge" id="badge-api">0</span></button>
        <button class="filter-chip play" data-filter="play">Plays <span class="filter-badge" id="badge-play">0</span></button>
        <button class="filter-chip animation" data-filter="animation">Animations <span class="filter-badge" id="badge-animation">0</span></button>
        <button class="filter-chip cache" data-filter="cache">Cache <span class="filter-badge" id="badge-cache">0</span></button>
        <button class="filter-chip state" data-filter="state">State <span class="filter-badge" id="badge-state">0</span></button>
        <button class="filter-chip error" data-filter="error">Errors <span class="filter-badge" id="badge-error">0</span></button>
        <div class="filter-spacer"></div>
        <button class="btn btn-danger" id="clear-logs">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:14px;height:14px"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          Clear
        </button>
      </div>

      <div class="tab-content active" data-content="logs">
        <div class="log-container" id="log-container">
          <div class="no-logs">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <div class="no-logs-text">No logs yet</div>
            <div class="no-logs-hint">Select a game to start monitoring</div>
          </div>
        </div>
      </div>

      <div class="tab-content" data-content="plays">
        <div class="log-container" id="plays-container">
          <div class="no-logs">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            <div class="no-logs-text">Play-by-play will appear here</div>
            <div class="no-logs-hint">Live plays are logged as they happen</div>
          </div>
        </div>
      </div>

      <div class="tab-content" data-content="api">
        <div class="api-response-panel" id="api-container">
          <div class="no-logs">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <div class="no-logs-text">API responses will appear here</div>
            <div class="no-logs-hint">Full response payloads are captured</div>
          </div>
        </div>
      </div>

      <div class="tab-content" data-content="state">
        <div class="state-panel" id="state-panel">
          <div class="state-card">
            <div class="state-card-header">
              <div class="state-card-title">Selected Game</div>
              <button class="btn" id="refresh-state">Refresh</button>
            </div>
            <div class="state-card-body" id="selected-game-state">
              <div style="color: var(--text-dim); text-align: center; padding: 20px;">No game selected</div>
            </div>
          </div>

          <div class="state-card">
            <div class="state-card-header">
              <div class="state-card-title">Previous Data</div>
            </div>
            <div class="state-card-body" id="prev-game-data-state">
              <div style="color: var(--text-dim); text-align: center; padding: 20px;">-</div>
            </div>
          </div>

          <div class="state-card">
            <div class="state-card-header">
              <div class="state-card-title">LocalStorage</div>
            </div>
            <div class="state-card-body" id="localstorage-state">
              <div style="color: var(--text-dim); text-align: center; padding: 20px;">-</div>
            </div>
          </div>

          <div class="state-card">
            <div class="state-card-header">
              <div class="state-card-title">Animation Queue</div>
            </div>
            <div class="state-card-body" id="animation-queue-state">
              <div style="color: var(--text-dim); text-align: center; padding: 20px;">-</div>
            </div>
          </div>

          <div class="state-card full-width">
            <div class="state-card-header">
              <div class="state-card-title">Server Cache Status</div>
              <button class="btn" id="refresh-cache-status">Refresh</button>
            </div>
            <div class="state-card-body" id="server-cache-state">
              <div style="color: var(--text-dim); text-align: center; padding: 20px;">Loading...</div>
            </div>
          </div>

          <div class="state-card full-width">
            <div class="state-card-header">
              <div class="state-card-title">ESPN API Health</div>
              <button class="btn" id="refresh-espn-status">Refresh</button>
            </div>
            <div class="state-card-body" id="espn-health-state">
              <div style="color: var(--text-dim); text-align: center; padding: 20px;">Loading...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal-backdrop" id="export-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title-group">
          <div class="modal-title">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
            Export Debug Logs
          </div>
          <div class="modal-subtitle" id="export-subtitle">Session data ready for export</div>
        </div>
        <button class="modal-close" id="close-export">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="export-info">
          <div class="export-info-item">
            <div class="export-info-label">Session</div>
            <div class="export-info-value" id="export-session">-</div>
          </div>
          <div class="export-info-item">
            <div class="export-info-label">Total Entries</div>
            <div class="export-info-value" id="export-entries">0</div>
          </div>
          <div class="export-info-item">
            <div class="export-info-label">Duration</div>
            <div class="export-info-value" id="export-duration">0m 0s</div>
          </div>
        </div>
        <textarea class="export-textarea" id="export-textarea" readonly></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-action" id="download-logs">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
          Download JSON
        </button>
        <button class="btn btn-primary btn-action" id="copy-logs">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
          Copy to Clipboard
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // DEBUG CONSOLE STATE
    // ============================================
    let selectedLeague = 'nfl';
    let selectedGame = null;
    let games = [];
    let logs = [];
    let isRefreshing = true;
    let refreshInterval = null;
    let prevGameData = new Map();
    let sessionStartTime = Date.now();

    // Stats counters
    let stats = { api: 0, plays: 0, animations: 0, errors: 0 };
    let statCounts = { api: [], plays: [], animations: [], errors: [] };
    let filterCounts = { api: 0, play: 0, animation: 0, cache: 0, state: 0, error: 0 };

    // API Endpoints
    const apiEndpoints = {
      'nfl': '/api/nfl/scoreboard',
      'nba': '/api/nba/scoreboard',
      'mlb': '/api/mlb/scoreboard',
      'nhl': '/api/nhl/scoreboard',
      'ncaa': '/api/ncaa/scoreboard',
      'ncaab': '/api/ncaab/scoreboard'
    };

    // ============================================
    // TAB INDICATOR
    // ============================================
    function updateTabIndicator() {
      const activeTab = document.querySelector('.tab.active');
      const indicator = document.getElementById('tab-indicator');
      if (activeTab && indicator) {
        indicator.style.left = activeTab.offsetLeft + 'px';
        indicator.style.width = activeTab.offsetWidth + 'px';
      }
    }

    // ============================================
    // SPARKLINES
    // ============================================
    function initSparklines() {
      ['api', 'plays', 'anim', 'errors'].forEach(type => {
        const container = document.getElementById(`sparkline-${type}`);
        if (container) {
          container.innerHTML = Array(8).fill(0).map(() =>
            `<div class="sparkline-bar" style="height: 2px;"></div>`
          ).join('');
        }
      });
    }

    function updateSparkline(type, values) {
      const container = document.getElementById(`sparkline-${type}`);
      if (!container) return;

      const max = Math.max(...values, 1);
      const bars = container.querySelectorAll('.sparkline-bar');
      values.slice(-8).forEach((val, i) => {
        if (bars[i]) {
          const height = Math.max(2, (val / max) * 24);
          bars[i].style.height = height + 'px';
        }
      });
    }

    // ============================================
    // LOGGING SYSTEM
    // ============================================
    function log(type, message, details = null) {
      const entry = {
        id: Date.now() + Math.random(),
        timestamp: new Date().toISOString(),
        time: new Date().toLocaleTimeString(),
        type,
        message,
        details,
        gameId: selectedGame?.id
      };

      logs.push(entry);

      // Update stats
      if (type === 'api') {
        stats.api++;
        statCounts.api.push(1);
      } else if (type === 'play') {
        stats.plays++;
        statCounts.plays.push(1);
      } else if (type === 'animation') {
        stats.animations++;
        statCounts.animations.push(1);
      } else if (type === 'error') {
        stats.errors++;
        statCounts.errors.push(1);
      }

      // Update filter counts
      if (filterCounts.hasOwnProperty(type)) {
        filterCounts[type]++;
        updateFilterBadges();
      }

      updateStats();
      renderLogs();

      // Keep log size manageable
      if (logs.length > 1000) {
        logs = logs.slice(-500);
      }
    }

    function updateStats() {
      const apiEl = document.getElementById('stat-api');
      const playsEl = document.getElementById('stat-plays');
      const animEl = document.getElementById('stat-animations');
      const errorsEl = document.getElementById('stat-errors');

      [
        { el: apiEl, val: stats.api },
        { el: playsEl, val: stats.plays },
        { el: animEl, val: stats.animations },
        { el: errorsEl, val: stats.errors }
      ].forEach(({ el, val }) => {
        if (el && el.textContent !== String(val)) {
          el.textContent = val;
          el.classList.add('bump');
          setTimeout(() => el.classList.remove('bump'), 300);
        }
      });

      // Update sparklines
      updateSparkline('api', statCounts.api.slice(-8));
      updateSparkline('plays', statCounts.plays.slice(-8));
      updateSparkline('anim', statCounts.animations.slice(-8));
      updateSparkline('errors', statCounts.errors.slice(-8));
    }

    function updateFilterBadges() {
      Object.keys(filterCounts).forEach(type => {
        const badge = document.getElementById(`badge-${type}`);
        if (badge) badge.textContent = filterCounts[type];
      });
    }

    function renderLogs() {
      const container = document.getElementById('log-container');
      const playsContainer = document.getElementById('plays-container');
      const activeFilter = document.querySelector('.filter-chip.active')?.dataset.filter || 'all';

      // Filter logs
      let filteredLogs = logs;
      if (activeFilter !== 'all') {
        filteredLogs = logs.filter(l => l.type === activeFilter);
      }

      // Render main log container
      if (filteredLogs.length === 0) {
        container.innerHTML = `
          <div class="no-logs">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <div class="no-logs-text">No logs yet</div>
            <div class="no-logs-hint">Select a game to start monitoring</div>
          </div>
        `;
      } else {
        container.innerHTML = filteredLogs.slice(-100).reverse().map(entry => `
          <div class="log-entry ${entry.type}">
            <span class="log-time">${entry.time}</span>
            <span class="log-type-badge">${entry.type}</span>
            <div class="log-message">
              ${entry.message}
              ${entry.details ? `<div class="log-details">${typeof entry.details === 'string' ? entry.details : JSON.stringify(entry.details, null, 2)}</div>` : ''}
            </div>
          </div>
        `).join('');
      }

      // Render plays container
      const playLogs = logs.filter(l => l.type === 'play');
      if (playLogs.length === 0) {
        playsContainer.innerHTML = `
          <div class="no-logs">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            <div class="no-logs-text">Play-by-play will appear here</div>
            <div class="no-logs-hint">Live plays are logged as they happen</div>
          </div>
        `;
      } else {
        playsContainer.innerHTML = playLogs.slice(-50).reverse().map(entry => `
          <div class="log-entry ${entry.type}">
            <span class="log-time">${entry.time}</span>
            <span class="log-type-badge">PLAY</span>
            <div class="log-message">
              ${entry.message}
              ${entry.details ? `<div class="log-details">${typeof entry.details === 'string' ? entry.details : JSON.stringify(entry.details, null, 2)}</div>` : ''}
            </div>
          </div>
        `).join('');
      }
    }

    // ============================================
    // GAME FETCHING & MONITORING
    // ============================================
    async function fetchGames() {
      const endpoint = apiEndpoints[selectedLeague];
      log('api', `Fetching ${selectedLeague.toUpperCase()} games from ${endpoint}`);

      try {
        const response = await fetch(endpoint);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        games = data.events || [];

        log('api', `Received ${games.length} games`, {
          games: games.map(g => ({
            id: g.id,
            name: g.shortName || g.name,
            state: g.status?.type?.state
          }))
        });

        renderGameList();
      } catch (err) {
        log('error', `Failed to fetch games: ${err.message}`);
      }
    }

    function renderGameList() {
      const container = document.getElementById('game-list');

      if (games.length === 0) {
        container.innerHTML = `
          <div class="no-games">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            <span>No games found</span>
          </div>
        `;
        return;
      }

      container.innerHTML = games.map(game => {
        const comp = game.competitions?.[0];
        const home = comp?.competitors?.find(c => c.homeAway === 'home');
        const away = comp?.competitors?.find(c => c.homeAway === 'away');
        const state = game.status?.type?.state || 'pre';
        const isLive = state === 'in';
        const isSelected = selectedGame?.id === game.id;

        // Calculate game progress for live games
        let progress = 0;
        if (isLive && game.status?.type?.shortDetail) {
          const detail = game.status.type.shortDetail.toLowerCase();
          if (detail.includes('1st')) progress = 12.5;
          else if (detail.includes('2nd')) progress = 37.5;
          else if (detail.includes('half')) progress = 50;
          else if (detail.includes('3rd')) progress = 62.5;
          else if (detail.includes('4th')) progress = 87.5;
          else progress = 50;
        }

        return `
          <div class="game-item ${state} ${isSelected ? 'active' : ''}" data-game-id="${game.id}">
            <div class="game-header">
              <span class="game-teams">${away?.team?.abbreviation || '?'} @ ${home?.team?.abbreviation || '?'}</span>
              <span class="game-status ${state}">${state === 'in' ? 'LIVE' : state === 'pre' ? 'PRE' : 'FINAL'}</span>
            </div>
            <div class="game-score">
              ${away?.score || 0} - ${home?.score || 0} | ${game.status?.type?.shortDetail || ''}
            </div>
            ${isLive ? `
              <div class="game-progress">
                <div class="game-progress-fill" style="width: ${progress}%"></div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      // Add click handlers
      container.querySelectorAll('.game-item').forEach(item => {
        item.addEventListener('click', () => {
          const gameId = item.dataset.gameId;
          selectGame(gameId);
        });
      });
    }

    function selectGame(gameId) {
      selectedGame = games.find(g => g.id === gameId);

      if (!selectedGame) {
        log('error', `Game ${gameId} not found`);
        return;
      }

      log('state', `Selected game: ${selectedGame.shortName || selectedGame.name}`, {
        id: selectedGame.id,
        state: selectedGame.status?.type?.state
      });

      // Update UI
      document.querySelectorAll('.game-item').forEach(item => {
        item.classList.toggle('active', item.dataset.gameId === gameId);
      });

      // Show monitoring status
      const monitoringStatus = document.getElementById('monitoring-status');
      const monitoringGame = document.getElementById('monitoring-game');
      monitoringStatus.style.display = 'flex';
      monitoringGame.textContent = selectedGame.shortName || selectedGame.name;

      updateStatePanel();
      startMonitoring();
    }

    // ============================================
    // GAME MONITORING
    // ============================================
    function startMonitoring() {
      if (refreshInterval) clearInterval(refreshInterval);

      if (isRefreshing && selectedGame) {
        refreshGameData();
        refreshInterval = setInterval(refreshGameData, 10000);
      }
    }

    async function refreshGameData() {
      if (!selectedGame) return;

      const endpoint = apiEndpoints[selectedLeague];
      log('api', `Refreshing game data from ${endpoint}`);

      try {
        const response = await fetch(endpoint);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        const updatedGame = data.events?.find(e => e.id === selectedGame.id);

        if (updatedGame) {
          const prevData = prevGameData.get(selectedGame.id) || {};
          analyzeGameUpdate(updatedGame, prevData);

          // Store for next comparison
          const comp = updatedGame.competitions?.[0];
          prevGameData.set(selectedGame.id, {
            awayScore: parseInt(comp?.competitors?.find(c => c.homeAway === 'away')?.score || 0),
            homeScore: parseInt(comp?.competitors?.find(c => c.homeAway === 'home')?.score || 0),
            lastPlay: comp?.situation?.lastPlay?.text || '',
            down: comp?.situation?.down || 0,
            downDistanceText: comp?.situation?.downDistanceText || ''
          });

          selectedGame = updatedGame;
          games = data.events || [];
          renderGameList();
          updateStatePanel();
        }
      } catch (err) {
        log('error', `Refresh failed: ${err.message}`);
      }
    }

    function analyzeGameUpdate(game, prevData) {
      const comp = game.competitions?.[0];
      const situation = comp?.situation;
      const lastPlay = situation?.lastPlay?.text || '';

      const away = comp?.competitors?.find(c => c.homeAway === 'away');
      const home = comp?.competitors?.find(c => c.homeAway === 'home');
      const awayScore = parseInt(away?.score || 0);
      const homeScore = parseInt(home?.score || 0);

      // Check for score changes
      const awayScoreChange = awayScore - (prevData.awayScore || 0);
      const homeScoreChange = homeScore - (prevData.homeScore || 0);

      if (awayScoreChange > 0 || homeScoreChange > 0) {
        log('state', `Score change detected`, {
          away: `${prevData.awayScore || 0} -> ${awayScore} (+${awayScoreChange})`,
          home: `${prevData.homeScore || 0} -> ${homeScore} (+${homeScoreChange})`
        });
      }

      // Check for new play
      if (lastPlay && lastPlay !== prevData.lastPlay) {
        log('play', `New play detected`, {
          fullText: lastPlay,
          down: situation?.down,
          distance: situation?.distance,
          yardLine: situation?.yardLine,
          possession: situation?.possession,
          downDistanceText: situation?.downDistanceText
        });

        detectAnimations(lastPlay, awayScoreChange, homeScoreChange, situation);
      }

      // Log situation changes - compare normalized values
      const currentDownDist = situation?.downDistanceText || '';
      const prevDownDist = prevData.downDistanceText || '';
      if (currentDownDist !== prevDownDist) {
        log('state', `Down/distance changed: ${prevDownDist || 'N/A'} -> ${currentDownDist || 'N/A'}`);
      }
    }

    function detectAnimations(lastPlay, awayScoreChange, homeScoreChange, situation) {
      const lowerPlay = lastPlay.toLowerCase();
      const animations = [];

      // Touchdown detection
      if (lowerPlay.includes('touchdown') || lowerPlay.includes('for a td')) {
        const isXP = lowerPlay.includes('extra point') || lowerPlay.includes('pat ') ||
                     lowerPlay.includes(' xp ') || lowerPlay.includes('two-point') ||
                     lowerPlay.includes('2-pt');
        if (!isXP) {
          animations.push({ type: 'touchdown', reason: 'Play text contains touchdown' });
        }
      }

      // Interception
      if (lowerPlay.includes('intercept')) {
        animations.push({ type: 'interception', reason: 'Play text contains intercept' });
        if (lowerPlay.includes('touchdown') || lowerPlay.includes('for a td')) {
          animations.push({ type: 'pick-six', reason: 'INT returned for TD' });
        }
      }

      // Fumble
      if (lowerPlay.includes('fumble')) {
        animations.push({ type: 'fumble', reason: 'Play text contains fumble' });
        if (lowerPlay.includes('touchdown') || lowerPlay.includes('for a td')) {
          animations.push({ type: 'scoop-score', reason: 'Fumble returned for TD' });
        }
      }

      // Field goal
      if ((lowerPlay.includes('field goal') || lowerPlay.includes(' fg ')) &&
          lowerPlay.includes('good') && !lowerPlay.includes('no good')) {
        animations.push({ type: 'field-goal', reason: 'FG is good' });
      }

      // Missed FG
      if ((lowerPlay.includes('field goal') || lowerPlay.includes(' fg ')) &&
          (lowerPlay.includes('missed') || lowerPlay.includes('no good') || lowerPlay.includes('blocked'))) {
        animations.push({ type: 'missed-kick', reason: 'FG missed/blocked' });
      }

      // Extra point
      if ((lowerPlay.includes('extra point') || lowerPlay.includes('pat ') || lowerPlay.includes(' xp ')) &&
          lowerPlay.includes('good') && !lowerPlay.includes('no good')) {
        animations.push({ type: 'extra-point', reason: 'XP is good' });
      }

      // Safety
      if (lowerPlay.includes('safety') && !lowerPlay.includes('free kick')) {
        animations.push({ type: 'safety', reason: 'Safety detected' });
      }

      // Sack
      if (lowerPlay.includes('sack') || lowerPlay.includes('sacked')) {
        animations.push({ type: 'sack', reason: 'Sack detected' });
      }

      // Punt
      if (lowerPlay.includes('punt') && !lowerPlay.includes('fake') && !lowerPlay.includes('touchdown')) {
        animations.push({ type: 'punt', reason: 'Punt detected' });
      }

      // Penalty
      if ((lowerPlay.includes('penalty') || lowerPlay.includes('flag')) &&
          !lowerPlay.includes('no flags') && !lowerPlay.includes('declined')) {
        animations.push({ type: 'penalty', reason: 'Penalty detected' });
      }

      // First down
      if (lowerPlay.includes('1st down') || lowerPlay.includes('first down') ||
          lowerPlay.includes('for a 1st')) {
        animations.push({ type: 'first-down', reason: 'First down in play text' });
      }

      // Score-based fallback
      if (animations.length === 0) {
        if (awayScoreChange === 6 || homeScoreChange === 6) {
          animations.push({ type: 'touchdown', reason: 'Score +6 (fallback)' });
        } else if (awayScoreChange === 3 || homeScoreChange === 3) {
          animations.push({ type: 'field-goal', reason: 'Score +3 (fallback)' });
        } else if (awayScoreChange === 2 || homeScoreChange === 2) {
          animations.push({ type: 'safety-or-2pt', reason: 'Score +2 (fallback)' });
        } else if (awayScoreChange === 1 || homeScoreChange === 1) {
          animations.push({ type: 'extra-point', reason: 'Score +1 (fallback)' });
        }
      }

      if (animations.length > 0) {
        log('animation', `Would trigger: ${animations.map(a => a.type).join(', ')}`, animations);
      }
    }

    // ============================================
    // STATE PANEL
    // ============================================
    function updateStatePanel() {
      // Selected game state
      const gameStateEl = document.getElementById('selected-game-state');
      if (selectedGame) {
        const comp = selectedGame.competitions?.[0];
        const situation = comp?.situation;
        const away = comp?.competitors?.find(c => c.homeAway === 'away');
        const home = comp?.competitors?.find(c => c.homeAway === 'home');

        gameStateEl.innerHTML = `
          <div class="state-item"><span class="state-key">ID</span><span class="state-value">${selectedGame.id}</span></div>
          <div class="state-item"><span class="state-key">Name</span><span class="state-value">${selectedGame.shortName || selectedGame.name}</span></div>
          <div class="state-item"><span class="state-key">State</span><span class="state-value"><span class="status-dot ${selectedGame.status?.type?.state === 'in' ? 'green' : 'amber'}"></span>${selectedGame.status?.type?.state}</span></div>
          <div class="state-item"><span class="state-key">Status</span><span class="state-value">${selectedGame.status?.type?.shortDetail}</span></div>
          <div class="state-item"><span class="state-key">Away</span><span class="state-value">${away?.team?.abbreviation}: ${away?.score}</span></div>
          <div class="state-item"><span class="state-key">Home</span><span class="state-value">${home?.team?.abbreviation}: ${home?.score}</span></div>
          <div class="state-item"><span class="state-key">Down/Dist</span><span class="state-value">${situation?.downDistanceText || 'N/A'}</span></div>
          <div class="state-item"><span class="state-key">Possession</span><span class="state-value">${situation?.possession || 'N/A'}</span></div>
          <div class="state-item"><span class="state-key">Yard Line</span><span class="state-value">${situation?.yardLine || 'N/A'}</span></div>
        `;
      } else {
        gameStateEl.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 20px;">No game selected</div>';
      }

      // Prev game data
      const prevDataEl = document.getElementById('prev-game-data-state');
      if (selectedGame && prevGameData.has(selectedGame.id)) {
        const prev = prevGameData.get(selectedGame.id);
        prevDataEl.innerHTML = `
          <div class="state-item"><span class="state-key">Away Score</span><span class="state-value">${prev.awayScore}</span></div>
          <div class="state-item"><span class="state-key">Home Score</span><span class="state-value">${prev.homeScore}</span></div>
          <div class="state-item"><span class="state-key">Down</span><span class="state-value">${prev.down}</span></div>
          <div class="state-item"><span class="state-key">Last Play</span><span class="state-value" style="font-size: 10px; max-width: 180px;">${prev.lastPlay?.substring(0, 80)}...</span></div>
        `;
      } else {
        prevDataEl.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 20px;">No previous data</div>';
      }

      // LocalStorage
      const lsEl = document.getElementById('localstorage-state');
      const savedGames = localStorage.getItem('gridtv_sports_bar_games');
      if (savedGames) {
        try {
          const parsed = JSON.parse(savedGames);
          lsEl.innerHTML = `
            <div class="state-item"><span class="state-key">Saved Games</span><span class="state-value">${parsed.length}</span></div>
            <div class="json-viewer">${JSON.stringify(parsed.slice(0, 2), null, 2)}${parsed.length > 2 ? '\n... and more' : ''}</div>
          `;
        } catch (e) {
          lsEl.innerHTML = '<div style="color: var(--signal-red);">Parse error</div>';
        }
      } else {
        lsEl.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 20px;">No cached games</div>';
      }

      // Animation queue
      const animQueueEl = document.getElementById('animation-queue-state');
      animQueueEl.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 20px;">Animation queue tracking requires sports bar page</div>';

      fetchServerCacheStatus();
      fetchESPNHealthStatus();
    }

    async function fetchServerCacheStatus() {
      const cacheEl = document.getElementById('server-cache-state');
      try {
        const response = await fetch('/api/health/cache');
        const data = await response.json();

        log('cache', 'Server cache status fetched', {
          status: data.status,
          hits: data.stats?.hits,
          misses: data.stats?.misses,
          hitRate: data.stats?.hitRate,
          backgroundUpdates: data.stats?.backgroundUpdates,
          lastUpdate: data.stats?.lastBackgroundUpdate
        });

        const cacheForLeague = data.caches?.[selectedLeague];
        const activeKey = selectedLeague === 'nfl' || selectedLeague === 'ncaa' ? 'activeWeeks' : 'activeDates';
        const activeItems = cacheForLeague?.[activeKey] || [];

        const hits = data.stats?.hits || 0;
        const misses = data.stats?.misses || 0;
        const total = hits + misses;
        const hitPercent = total > 0 ? (hits / total * 100).toFixed(1) : 0;

        cacheEl.innerHTML = `
          <div class="state-item"><span class="state-key">Status</span><span class="state-value ${data.status === 'ready' ? 'success' : 'warning'}"><span class="status-dot ${data.status === 'ready' ? 'green' : 'amber'}"></span>${data.status}</span></div>
          <div class="state-item"><span class="state-key">Hit Rate</span><span class="state-value success">${data.stats?.hitRate || 'N/A'}</span></div>
          <div class="state-item"><span class="state-key">BG Updates</span><span class="state-value">${data.stats?.backgroundUpdates || 0}</span></div>
          <div class="state-item"><span class="state-key">Poll Interval</span><span class="state-value">${data.architecture?.pollInterval || '20s'}</span></div>
          <div class="state-item"><span class="state-key">${selectedLeague.toUpperCase()} Active</span><span class="state-value">${activeItems.join(', ') || 'None'}</span></div>

          <div class="progress-bar-container">
            <div class="progress-bar-label">
              <span style="color: var(--signal-green);">Hits: ${hits}</span>
              <span style="color: var(--signal-red);">Misses: ${misses}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-bar-fill success" style="width: ${hitPercent}%"></div>
            </div>
          </div>

          <div class="json-viewer">${JSON.stringify(cacheForLeague?.entries || {}, null, 2)}</div>
        `;
      } catch (error) {
        log('error', 'Failed to fetch cache status', { error: error.message });
        cacheEl.innerHTML = `<div style="color: var(--signal-red);">Error: ${error.message}</div>`;
      }
    }

    async function fetchESPNHealthStatus() {
      const espnEl = document.getElementById('espn-health-state');
      try {
        const response = await fetch('/api/health/espn');
        const data = await response.json();

        log('cache', 'ESPN API health fetched', {
          status: data.status,
          totalCalls: data.metrics?.totalCalls,
          successRate: data.metrics?.successRate,
          rateLimitHits: data.metrics?.rateLimitHits
        });

        const statusClass = data.status === 'healthy' ? 'success' : data.status === 'degraded' ? 'warning' : 'error';
        const statusDot = data.status === 'healthy' ? 'green' : data.status === 'degraded' ? 'amber' : 'red';

        espnEl.innerHTML = `
          <div class="state-item"><span class="state-key">Status</span><span class="state-value ${statusClass}"><span class="status-dot ${statusDot}"></span>${data.status}</span></div>
          <div class="state-item"><span class="state-key">Uptime</span><span class="state-value">${data.uptime}</span></div>
          <div class="state-item"><span class="state-key">Total Calls</span><span class="state-value">${data.metrics?.totalCalls || 0}</span></div>
          <div class="state-item"><span class="state-key">Success Rate</span><span class="state-value success">${data.metrics?.successRate || 'N/A'}</span></div>
          <div class="state-item"><span class="state-key">Rate Limit Hits</span><span class="state-value warning">${data.metrics?.rateLimitHits || 0}</span></div>
          ${data.lastError ? `<div class="state-item"><span class="state-key">Last Error</span><span class="state-value error" style="font-size: 10px;">${JSON.stringify(data.lastError)}</span></div>` : ''}
        `;
      } catch (error) {
        log('error', 'Failed to fetch ESPN health', { error: error.message });
        espnEl.innerHTML = `<div style="color: var(--signal-red);">Error: ${error.message}</div>`;
      }
    }

    // ============================================
    // EXPORT FUNCTIONALITY
    // ============================================
    function exportLogs() {
      const duration = Math.floor((Date.now() - sessionStartTime) / 1000);
      const minutes = Math.floor(duration / 60);
      const seconds = duration % 60;

      const exportData = {
        exportedAt: new Date().toISOString(),
        session: {
          league: selectedLeague,
          gameId: selectedGame?.id,
          gameName: selectedGame?.shortName || selectedGame?.name,
          duration: `${minutes}m ${seconds}s`,
          stats: { ...stats }
        },
        logs: logs.map(l => ({ ...l, id: undefined }))
      };

      document.getElementById('export-session').textContent = selectedGame?.shortName || selectedLeague.toUpperCase();
      document.getElementById('export-entries').textContent = logs.length.toLocaleString();
      document.getElementById('export-duration').textContent = `${minutes}m ${seconds}s`;

      const formatted = JSON.stringify(exportData, null, 2);
      document.getElementById('export-textarea').value = formatted;
      document.getElementById('export-modal').classList.add('show');
    }

    // ============================================
    // GLOBAL ERROR HANDLER
    // ============================================
    window.onerror = function(message, source, lineno, colno, error) {
      const shortSource = source ? source.split('/').pop() : 'unknown';
      log('error', `${message}`, {
        source: shortSource,
        line: lineno,
        column: colno,
        stack: error?.stack?.split('\n').slice(0, 3).join('\n')
      });
      return false; // Don't suppress the error
    };

    window.addEventListener('unhandledrejection', function(event) {
      log('error', `Unhandled Promise: ${event.reason?.message || event.reason}`, {
        stack: event.reason?.stack?.split('\n').slice(0, 3).join('\n')
      });
    });

    // ============================================
    // EVENT LISTENERS
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      // Init
      initSparklines();
      updateTabIndicator();

      // League tabs
      document.querySelectorAll('.league-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.league-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          selectedLeague = tab.dataset.league;
          games = [];
          selectedGame = null;
          document.getElementById('monitoring-status').style.display = 'none';
          renderGameList();
          log('state', `Switched to ${selectedLeague.toUpperCase()}`);
        });
      });

      // Fetch games button
      document.getElementById('fetch-games').addEventListener('click', fetchGames);

      // Toggle refresh
      document.getElementById('toggle-refresh').addEventListener('click', () => {
        isRefreshing = !isRefreshing;
        const btn = document.getElementById('toggle-refresh');
        btn.querySelector('span').textContent = isRefreshing ? 'Pause' : 'Resume';

        const progress = document.getElementById('refresh-progress');
        progress.style.animationPlayState = isRefreshing ? 'running' : 'paused';

        if (isRefreshing) {
          startMonitoring();
        } else if (refreshInterval) {
          clearInterval(refreshInterval);
        }
      });

      // Tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.querySelector(`[data-content="${tab.dataset.tab}"]`).classList.add('active');
          updateTabIndicator();
        });
      });

      // Filters
      document.querySelectorAll('.filter-chip').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderLogs();
        });
      });

      // Clear logs
      document.getElementById('clear-logs').addEventListener('click', () => {
        logs = [];
        stats = { api: 0, plays: 0, animations: 0, errors: 0 };
        statCounts = { api: [], plays: [], animations: [], errors: [] };
        filterCounts = { api: 0, play: 0, animation: 0, cache: 0, state: 0, error: 0 };
        updateStats();
        updateFilterBadges();
        initSparklines();
        renderLogs();
        log('state', 'Logs cleared');
      });

      // Export
      document.getElementById('export-btn').addEventListener('click', exportLogs);
      document.getElementById('close-export').addEventListener('click', () => {
        document.getElementById('export-modal').classList.remove('show');
      });

      document.getElementById('export-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('export-modal')) {
          document.getElementById('export-modal').classList.remove('show');
        }
      });

      document.getElementById('copy-logs').addEventListener('click', () => {
        const textarea = document.getElementById('export-textarea');
        textarea.select();
        document.execCommand('copy');
        const btn = document.getElementById('copy-logs');
        btn.classList.add('success');
        btn.innerHTML = `
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          Copied!
        `;
        setTimeout(() => {
          btn.classList.remove('success');
          btn.innerHTML = `
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
            Copy to Clipboard
          `;
        }, 2000);
      });

      document.getElementById('download-logs').addEventListener('click', () => {
        const content = document.getElementById('export-textarea').value;
        const blob = new Blob([content], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gridtv-debug-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
      });

      // Refresh state button
      document.getElementById('refresh-state').addEventListener('click', updateStatePanel);
      document.getElementById('refresh-cache-status').addEventListener('click', fetchServerCacheStatus);
      document.getElementById('refresh-espn-status').addEventListener('click', fetchESPNHealthStatus);

      // Window resize for tab indicator
      window.addEventListener('resize', updateTabIndicator);

      // Initial log
      log('state', 'Mission Control initialized');

      // Initial fetch of server status
      fetchServerCacheStatus();
      fetchESPNHealthStatus();

      // Auto-refresh server stats every 10 seconds
      setInterval(() => {
        fetchServerCacheStatus();
        fetchESPNHealthStatus();
      }, 10000);
    });
  </script>
</body>
</html>

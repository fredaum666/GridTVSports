<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GridTV Sports - TV Display</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì∫</text></svg>">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0e1a;
      color: #e0e0e0;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Connection Screen */
    .connection-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .connection-screen.hidden {
      display: none;
    }

    .logo-container {
      margin-bottom: 40px;
      text-align: center;
    }

    .logo-container h1 {
      font-size: 3rem;
      color: #fff;
      margin-bottom: 10px;
    }

    .logo-container p {
      font-size: 1.2rem;
      color: #94a3b8;
    }

    .room-code-container {
      background: #1a1f2e;
      border: 3px solid #334155;
      border-radius: 20px;
      padding: 40px 60px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    .room-code-label {
      font-size: 1.5rem;
      color: #94a3b8;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .room-code {
      font-size: 6rem;
      font-weight: 900;
      color: #22c55e;
      letter-spacing: 15px;
      font-family: 'Courier New', monospace;
      text-shadow: 0 0 30px rgba(34, 197, 94, 0.5);
    }

    .room-code.connecting {
      color: #fbbf24;
      animation: pulse 1.5s infinite;
    }

    .room-code.error {
      color: #ef4444;
      font-size: 2rem;
      letter-spacing: 0;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .instructions {
      margin-top: 40px;
      text-align: center;
      max-width: 500px;
    }

    .instructions h3 {
      font-size: 1.3rem;
      color: #e5e7eb;
      margin-bottom: 15px;
    }

    .instructions ol {
      text-align: left;
      font-size: 1.1rem;
      color: #94a3b8;
      line-height: 2;
    }

    .instructions li {
      margin-bottom: 8px;
    }

    .instructions .highlight {
      color: #22c55e;
      font-weight: 700;
    }

    .connection-status {
      margin-top: 30px;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
    }

    .connection-status.waiting {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border: 2px solid #fbbf24;
    }

    .connection-status.connected {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 2px solid #22c55e;
    }

    .remote-count {
      margin-top: 20px;
      font-size: 1rem;
      color: #64748b;
    }

    /* Fullscreen Grid Display */
    .fullscreen-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #0a0e1a;
      display: none;
      flex-direction: column;
    }

    .fullscreen-container.active {
      display: flex;
    }

    .tv-header {
      background: rgba(26, 31, 46, 0.95);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #334155;
      height: 60px;
    }

    .tv-header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .tv-header h2 {
      font-size: 1.2rem;
      color: #fff;
    }

    .room-badge {
      background: #22c55e;
      color: #000;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 1rem;
    }

    .remote-badge {
      background: #334155;
      color: #94a3b8;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .remote-badge.active {
      background: #3b82f6;
      color: #fff;
    }

    .fullscreen-grid {
      flex: 1;
      display: grid;
      gap: clamp(10px, 1.5vh, 20px);
      padding: clamp(15px, 2vh, 25px);
      overflow: hidden;
      height: calc(100vh - 60px);
      box-sizing: border-box;
    }

    .fullscreen-grid.grid-1 {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr;
      place-items: center;
    }

    .fullscreen-grid.grid-2 {
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: 1fr;
    }

    .fullscreen-grid.grid-4 {
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
    }

    .fullscreen-grid.grid-6 {
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
    }

    .fullscreen-grid.grid-8 {
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(2, 1fr);
    }

    /* Game Card Styles */
    .fullscreen-game-card {
      background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
      border-radius: clamp(8px, 1.2vh, 16px);
      padding: clamp(15px, 2.5vh, 30px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      border: 3px solid #334155;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 0;
      box-sizing: border-box;
      overflow: hidden;
    }

    .fullscreen-game-card.winning-home,
    .fullscreen-game-card.winning-away {
      border-color: #22c55e;
      background: linear-gradient(135deg, #1a1f2e 0%, #1e3a2e 100%);
    }

    .fullscreen-game-card.tied {
      border-color: #fbbf24;
      background: linear-gradient(135deg, #1a1f2e 0%, #3a2e1e 100%);
    }

    .fullscreen-game-card.upcoming-game {
      border-color: #6366f1;
      background: linear-gradient(135deg, #1a1f2e 0%, #1e2a3a 100%);
    }

    .fullscreen-game-card.final-game {
      border-color: #64748b;
      opacity: 0.9;
    }

    .sport-logo-indicator {
      position: absolute;
      top: 15px;
      left: 15px;
      width: clamp(60px, 8vmin, 120px);
      height: clamp(60px, 8vmin, 120px);
      object-fit: contain;
      opacity: 0.9;
    }

    .fullscreen-card-content {
      width: 100%;
      height: 100%;
      min-height: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: clamp(12px, 2.5vh, 40px);
      padding: clamp(10px, 2vmin, 30px);
      box-sizing: border-box;
      overflow: hidden;
    }

    .fullscreen-live-score-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(15px, 3vw, 50px);
      width: 100%;
      max-width: 95%;
      margin: 0 auto;
      flex-shrink: 1;
      min-height: 0;
    }

    .fullscreen-team-stack {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: clamp(5px, 1vh, 12px);
      position: relative;
      flex-shrink: 1;
      min-height: 0;
    }

    .fullscreen-team-logo {
      width: clamp(50px, 10vmin, 100px);
      height: clamp(50px, 10vmin, 100px);
      object-fit: contain;
      flex-shrink: 1;
    }

    .fullscreen-live-team-name {
      font-size: clamp(1.2rem, 3vmin, 2.5rem);
      font-weight: 900;
      color: #e5e7eb;
      text-align: center;
      white-space: nowrap;
    }

    .fullscreen-live-team-name.winning {
      color: #22c55e;
    }

    .fullscreen-team-record {
      font-size: clamp(0.8rem, 1.8vmin, 1.2rem);
      color: #9ca3b8;
      font-weight: 600;
      text-align: center;
    }

    .fullscreen-team-score {
      font-size: clamp(3rem, 10vmin, 7rem);
      font-weight: 900;
      color: #fff;
      min-width: clamp(70px, 15vw, 150px);
      text-align: center;
      flex-shrink: 0;
      line-height: 1;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    }

    .fullscreen-team-score.winning {
      color: #22c55e;
    }

    .fullscreen-team-score.losing {
      color: #9ca3af;
    }

    .fullscreen-vs-divider-live {
      font-size: clamp(1.2rem, 2.5vmin, 2rem);
      font-weight: 700;
      color: #64748b;
      flex-shrink: 0;
    }

    .fullscreen-status-container {
      margin-bottom: clamp(15px, 3vh, 30px);
      width: 100%;
      text-align: center;
    }

    .fullscreen-status-text {
      font-size: clamp(1.2rem, 3vmin, 2.5rem);
      font-weight: 700;
      color: #22c55e;
      text-transform: uppercase;
    }

    .fullscreen-upcoming-status-text {
      font-size: clamp(1.2rem, 3vmin, 2rem);
      font-weight: 700;
      color: #818cf8;
      margin-bottom: clamp(15px, 3vh, 25px);
      text-align: center;
    }

    .fullscreen-situation-info {
      font-size: clamp(1.2rem, 3vmin, 2rem);
      color: #fbbf24;
      font-weight: 700;
      text-align: center;
      margin-top: clamp(10px, 2vh, 20px);
    }

    .fullscreen-possession {
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: clamp(1rem, 2.5vmin, 1.8rem);
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Empty slot */
    .empty-slot-card {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      border: 3px dashed #475569;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #64748b;
      font-size: 1.5rem;
    }

    .empty-slot-card .slot-number {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    /* Waiting for games message */
    .waiting-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #94a3b8;
    }

    .waiting-message h2 {
      font-size: 2rem;
      margin-bottom: 20px;
    }

    .waiting-message p {
      font-size: 1.2rem;
    }

    /* Grid-specific sizing */
    .fullscreen-grid.grid-1 .fullscreen-team-logo {
      width: clamp(80px, 12vmin, 140px);
      height: clamp(80px, 12vmin, 140px);
    }

    .fullscreen-grid.grid-1 .fullscreen-team-score {
      font-size: clamp(5rem, 14vmin, 10rem);
    }

    .fullscreen-grid.grid-6 .fullscreen-team-logo {
      width: clamp(35px, 6vmin, 60px);
      height: clamp(35px, 6vmin, 60px);
    }

    .fullscreen-grid.grid-6 .fullscreen-team-score {
      font-size: clamp(2rem, 6vmin, 4rem);
    }

    .fullscreen-grid.grid-6 .fullscreen-live-team-name {
      font-size: clamp(0.9rem, 2vmin, 1.4rem);
    }

    .fullscreen-grid.grid-8 .fullscreen-team-logo {
      width: clamp(30px, 5vmin, 50px);
      height: clamp(30px, 5vmin, 50px);
    }

    .fullscreen-grid.grid-8 .fullscreen-team-score {
      font-size: clamp(1.5rem, 5vmin, 3rem);
    }

    .fullscreen-grid.grid-8 .fullscreen-live-team-name {
      font-size: clamp(0.8rem, 1.5vmin, 1.2rem);
    }
  </style>
</head>
<body>
  <!-- Connection Screen -->
  <div id="connection-screen" class="connection-screen">
    <div class="logo-container">
      <h1>GridTV Sports</h1>
      <p>TV Display Mode</p>
    </div>

    <div class="room-code-container">
      <div class="room-code-label">Enter this code on your device</div>
      <div id="room-code" class="room-code connecting">...</div>
    </div>

    <div class="instructions">
      <h3>How to connect:</h3>
      <ol>
        <li>On your phone or tablet, go to <span class="highlight">LiveGames</span></li>
        <li>Tap the <span class="highlight">"Connect to TV"</span> button</li>
        <li>Enter the code shown above</li>
        <li>Select your games and they'll appear here!</li>
      </ol>
    </div>

    <div id="connection-status" class="connection-status waiting">
      Waiting for device to connect...
    </div>

    <div id="remote-count" class="remote-count"></div>
  </div>

  <!-- Fullscreen Display -->
  <div id="fullscreen-container" class="fullscreen-container">
    <div class="tv-header">
      <div class="tv-header-left">
        <h2>GridTV Sports</h2>
        <span id="header-room-code" class="room-badge">----</span>
      </div>
      <span id="header-remote-count" class="remote-badge">No remotes connected</span>
    </div>
    <div id="fullscreen-grid" class="fullscreen-grid grid-4">
      <!-- Game cards will be rendered here -->
    </div>
  </div>

  <script>
    // ============================================
    // TV DISPLAY - WEBSOCKET CLIENT
    // ============================================

    let ws = null;
    let roomCode = null;
    let currentState = {
      layout: 4,
      games: {},
      gamesData: {}
    };
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;
    let dataRefreshInterval = null;

    // DOM Elements
    const connectionScreen = document.getElementById('connection-screen');
    const fullscreenContainer = document.getElementById('fullscreen-container');
    const roomCodeEl = document.getElementById('room-code');
    const connectionStatus = document.getElementById('connection-status');
    const remoteCountEl = document.getElementById('remote-count');
    const headerRoomCode = document.getElementById('header-room-code');
    const headerRemoteCount = document.getElementById('header-remote-count');
    const fullscreenGrid = document.getElementById('fullscreen-grid');

    // Connect to WebSocket server
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;

      console.log('Connecting to WebSocket:', wsUrl);
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('WebSocket connected');
        reconnectAttempts = 0;

        // Request a new room
        ws.send(JSON.stringify({
          type: 'tv-create-room',
          initialState: currentState
        }));
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (error) {
          console.error('Error parsing message:', error);
        }
      };

      ws.onclose = () => {
        console.log('WebSocket disconnected');
        roomCodeEl.textContent = 'Disconnected';
        roomCodeEl.className = 'room-code error';

        // Try to reconnect
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
          console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`);
          setTimeout(connectWebSocket, delay);
        }
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
    }

    // Handle incoming messages
    function handleMessage(data) {
      switch (data.type) {
        case 'room-created':
          roomCode = data.roomCode;
          roomCodeEl.textContent = roomCode;
          roomCodeEl.className = 'room-code';
          headerRoomCode.textContent = roomCode;
          console.log('Room created:', roomCode);
          break;

        case 'remote-connected':
          updateRemoteCount(data.remoteCount);
          connectionStatus.textContent = `${data.remoteCount} device(s) connected`;
          connectionStatus.className = 'connection-status connected';
          break;

        case 'remote-disconnected':
          updateRemoteCount(data.remoteCount);
          if (data.remoteCount === 0) {
            connectionStatus.textContent = 'Waiting for device to connect...';
            connectionStatus.className = 'connection-status waiting';
          } else {
            connectionStatus.textContent = `${data.remoteCount} device(s) connected`;
          }
          break;

        case 'state-update':
          console.log('State update received:', data.state);
          handleStateUpdate(data.state, data.fullState);
          break;

        case 'error':
          console.error('Server error:', data.message);
          break;
      }
    }

    // Update remote count display
    function updateRemoteCount(count) {
      if (count === 0) {
        remoteCountEl.textContent = '';
        headerRemoteCount.textContent = 'No remotes connected';
        headerRemoteCount.className = 'remote-badge';
      } else {
        remoteCountEl.textContent = `${count} device(s) controlling this TV`;
        headerRemoteCount.textContent = `${count} remote(s) connected`;
        headerRemoteCount.className = 'remote-badge active';
      }
    }

    // Handle state updates from remote
    function handleStateUpdate(partialState, fullState) {
      // Merge state
      if (fullState) {
        currentState = fullState;
      } else {
        currentState = { ...currentState, ...partialState };
      }

      console.log('Current state:', currentState);

      // Check if we have games to display
      const hasGames = currentState.games && Object.keys(currentState.games).some(k => currentState.games[k]);

      if (hasGames) {
        // Show fullscreen display
        connectionScreen.classList.add('hidden');
        fullscreenContainer.classList.add('active');

        // Update grid layout
        updateGridLayout(currentState.layout || 4);

        // Render games
        renderGames();

        // Start data refresh if not already running
        if (!dataRefreshInterval) {
          startDataRefresh();
        }
      } else {
        // Show connection screen
        connectionScreen.classList.remove('hidden');
        fullscreenContainer.classList.remove('active');
      }
    }

    // Update grid layout
    function updateGridLayout(layout) {
      fullscreenGrid.className = `fullscreen-grid grid-${layout}`;
    }

    // Render games in the grid
    function renderGames() {
      const layout = currentState.layout || 4;
      const games = currentState.games || {};
      const gamesData = currentState.gamesData || {};

      fullscreenGrid.innerHTML = '';

      for (let i = 0; i < layout; i++) {
        const gameId = games[i];
        const gameData = gamesData[gameId];

        if (gameId && gameData) {
          const card = createGameCard(gameData, i);
          fullscreenGrid.appendChild(card);
        } else {
          // Empty slot
          const emptyCard = document.createElement('div');
          emptyCard.className = 'fullscreen-game-card empty-slot-card';
          emptyCard.innerHTML = `
            <div class="slot-number">${i + 1}</div>
            <div>Waiting for game selection...</div>
          `;
          fullscreenGrid.appendChild(emptyCard);
        }
      }
    }

    // Create a game card
    function createGameCard(game, slotIndex) {
      const div = document.createElement('div');

      const comp = game.competitions?.[0];
      const homeTeam = comp?.competitors?.find(c => c.homeAway === 'home');
      const awayTeam = comp?.competitors?.find(c => c.homeAway === 'away');

      const homeScore = parseInt(homeTeam?.score || '0');
      const awayScore = parseInt(awayTeam?.score || '0');

      const statusState = comp?.status?.type?.state;
      const isLive = statusState === 'in';
      const isFinal = statusState === 'post';
      const isUpcoming = statusState === 'pre';

      // Determine card class
      let cardClass = 'fullscreen-game-card';
      if (isLive || isFinal) {
        if (homeScore > awayScore) cardClass += ' winning-home';
        else if (awayScore > homeScore) cardClass += ' winning-away';
        else cardClass += ' tied';
      }
      if (isUpcoming) cardClass += ' upcoming-game';
      if (isFinal) cardClass += ' final-game';

      div.className = cardClass;

      // Get status text
      let statusText = '';
      if (isLive) {
        statusText = comp?.status?.type?.shortDetail || 'LIVE';
      } else if (isFinal) {
        statusText = 'FINAL';
      } else if (isUpcoming) {
        statusText = comp?.status?.type?.shortDetail || 'Upcoming';
      }

      // Get sport type and logo
      const sport = game.sport || 'nfl';
      const sportLogos = {
        nfl: '/assets/NFL-logo.png',
        ncaa: '/assets/NCAA logo.png',
        nba: '/assets/NBA-logo.png',
        mlb: '/assets/MLB-logo.png',
        nhl: '/assets/NHL-logo.png'
      };
      const sportLogo = sportLogos[sport] || sportLogos.nfl;

      // Get records
      const homeRecord = homeTeam?.records?.[0]?.summary || '';
      const awayRecord = awayTeam?.records?.[0]?.summary || '';

      // Get situation info (for football)
      const situation = comp?.situation;
      const possession = situation?.possession;
      const downDistance = situation?.downDistanceText || '';

      div.innerHTML = `
        <img src="${sportLogo}" alt="${sport.toUpperCase()}" class="sport-logo-indicator">
        <div class="fullscreen-card-content">
          ${isUpcoming ? `
            <div class="fullscreen-upcoming-status-text">${statusText}</div>
          ` : `
            <div class="fullscreen-status-container">
              <div class="fullscreen-status-text">${statusText}</div>
            </div>
          `}
          <div class="fullscreen-live-score-header">
            <div class="fullscreen-team-stack">
              ${awayTeam?.team?.logo ? `<img src="${awayTeam.team.logo}" alt="${awayTeam.team.displayName}" class="fullscreen-team-logo">` : ''}
              <div class="fullscreen-live-team-name ${awayScore > homeScore ? 'winning' : ''}">${awayTeam?.team?.abbreviation || 'AWAY'}${isLive && possession === awayTeam?.id ? ' <span class="fullscreen-possession">üèà</span>' : ''}</div>
              ${awayRecord ? `<div class="fullscreen-team-record">${awayRecord}</div>` : ''}
            </div>
            <div class="fullscreen-team-score ${awayScore > homeScore ? 'winning' : 'losing'}">${isUpcoming ? '-' : awayScore}</div>
            <div class="fullscreen-vs-divider-live">VS</div>
            <div class="fullscreen-team-score ${homeScore > awayScore ? 'winning' : 'losing'}">${isUpcoming ? '-' : homeScore}</div>
            <div class="fullscreen-team-stack">
              ${homeTeam?.team?.logo ? `<img src="${homeTeam.team.logo}" alt="${homeTeam.team.displayName}" class="fullscreen-team-logo">` : ''}
              <div class="fullscreen-live-team-name ${homeScore > awayScore ? 'winning' : ''}">${homeTeam?.team?.abbreviation || 'HOME'}${isLive && possession === homeTeam?.id ? ' <span class="fullscreen-possession">üèà</span>' : ''}</div>
              ${homeRecord ? `<div class="fullscreen-team-record">${homeRecord}</div>` : ''}
            </div>
          </div>
          ${isLive && downDistance ? `<div class="fullscreen-situation-info">${downDistance}</div>` : ''}
        </div>
      `;

      return div;
    }

    // Start periodic data refresh
    function startDataRefresh() {
      // Refresh game data every 15 seconds
      dataRefreshInterval = setInterval(async () => {
        if (!currentState.games) return;

        const gameIds = Object.values(currentState.games).filter(id => id);
        if (gameIds.length === 0) return;

        // Fetch fresh data for all games
        for (const gameId of gameIds) {
          try {
            // Find which sport this game belongs to
            const gameData = currentState.gamesData[gameId];
            if (!gameData) continue;

            const sport = gameData.sport || 'nfl';
            const response = await fetch(`/api/${sport}/summary/${gameId}`);

            if (response.ok) {
              const freshData = await response.json();
              // Update the game data
              if (freshData.header?.competitions?.[0]) {
                const comp = freshData.header.competitions[0];
                currentState.gamesData[gameId] = {
                  ...currentState.gamesData[gameId],
                  competitions: [comp]
                };
              }
            }
          } catch (error) {
            console.error('Error refreshing game data:', error);
          }
        }

        // Re-render with fresh data
        renderGames();
      }, 15000);
    }

    // Initialize
    connectWebSocket();
  </script>
</body>
</html>

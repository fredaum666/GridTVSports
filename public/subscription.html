<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Subscription - GridTV Sports</title>
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      color: #ffffff;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 40px;
      background: rgba(26, 26, 46, 0.9);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }

    .app-title {
      font-size: 24px;
      font-weight: 700;
      color: #ffffff;
    }

    .back-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #ffffff;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 60px 20px;
    }

    .page-title {
      text-align: center;
      margin-bottom: 40px;
    }

    .page-title h1 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .subscription-card {
      background: rgba(26, 26, 46, 0.95);
      border-radius: 20px;
      padding: 40px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 30px;
    }

    .status-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-info h2 {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 5px;
    }

    .status-badge {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.active {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
    }

    .status-badge.trial {
      background: rgba(99, 102, 241, 0.2);
      color: #a5b4fc;
    }

    .status-badge.expired {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }

    .status-badge.canceled {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .subscription-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 25px;
    }

    .detail-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 12px;
    }

    .detail-item label {
      display: block;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .detail-item .value {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
    }

    .detail-item .value.highlight {
      color: #6366f1;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: #ffffff;
    }

    .action-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .action-btn:hover {
      transform: translateY(-2px);
    }

    .action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .success-message {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #4ade80;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      text-align: center;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    .info-card {
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .info-card h4 {
      color: #a5b4fc;
      margin-bottom: 10px;
    }

    .info-card p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      line-height: 1.6;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: rgba(255, 255, 255, 0.6);
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #6366f1;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .header {
        padding: 15px 20px;
      }

      .container {
        padding: 30px 15px;
      }

      .subscription-card {
        padding: 25px;
      }

      .status-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .action-buttons {
        flex-direction: column;
      }

      .action-btn {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo-section">
      <img src="/assets/logo.png" alt="GridTV Sports Logo" class="logo">
      <h1 class="app-title">GridTV Sports</h1>
    </div>
    <a href="/" class="back-btn">Back to App</a>
  </header>

  <div class="container">
    <div class="page-title">
      <h1>My Subscription</h1>
    </div>

    <div class="success-message" id="successMessage"></div>

    <div id="content">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>Loading subscription details...</p>
      </div>
    </div>
  </div>

  <script>
    const content = document.getElementById('content');
    const successMessage = document.getElementById('successMessage');

    // Check for success from checkout
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      successMessage.innerHTML = '<strong>Payment successful!</strong> Thank you for subscribing to GridTV Sports.';
      successMessage.classList.add('show');
      // Remove the query param from URL
      window.history.replaceState({}, document.title, '/subscription');
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    async function loadSubscription() {
      try {
        const response = await fetch('/api/subscription/status');

        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = '/login';
            return;
          }
          throw new Error('Failed to load subscription');
        }

        const data = await response.json();
        renderSubscription(data);
      } catch (error) {
        console.error('Error loading subscription:', error);
        content.innerHTML = `
          <div class="subscription-card">
            <p style="text-align: center; color: rgba(255,255,255,0.6);">
              Failed to load subscription details. Please try again.
            </p>
            <div class="action-buttons" style="justify-content: center;">
              <button class="action-btn secondary" onclick="location.reload()">Retry</button>
            </div>
          </div>
        `;
      }
    }

    function renderSubscription(data) {
      let statusClass = 'trial';
      let statusText = 'Trial';

      if (data.status === 'active') {
        statusClass = 'active';
        statusText = 'Active';
      } else if (data.status === 'expired') {
        statusClass = 'expired';
        statusText = 'Expired';
      } else if (data.status === 'canceled') {
        statusClass = 'canceled';
        statusText = 'Canceled';
      } else if (data.status === 'past_due') {
        statusClass = 'expired';
        statusText = 'Past Due';
      }

      let endDate = '';
      if (data.status === 'trial') {
        endDate = formatDate(data.trialEndsAt);
      } else if (data.subscriptionEndsAt) {
        endDate = formatDate(data.subscriptionEndsAt);
      }

      let planName = data.plan ? data.plan.charAt(0).toUpperCase() + data.plan.slice(1) : 'None';

      content.innerHTML = `
        <div class="subscription-card">
          <div class="status-header">
            <div class="status-info">
              <h2>Subscription Status</h2>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </div>
            ${data.daysRemaining > 0 ? `
              <div style="text-align: right;">
                <div style="font-size: 32px; font-weight: 700; color: #6366f1;">${data.daysRemaining}</div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.5);">days remaining</div>
              </div>
            ` : ''}
          </div>

          <div class="subscription-details">
            <div class="detail-item">
              <label>Plan</label>
              <div class="value ${data.plan ? 'highlight' : ''}">${planName}</div>
            </div>
            <div class="detail-item">
              <label>${data.status === 'trial' ? 'Trial Ends' : 'Renews On'}</label>
              <div class="value">${endDate || 'N/A'}</div>
            </div>
            <div class="detail-item">
              <label>Status</label>
              <div class="value">${statusText}</div>
            </div>
          </div>

          <div class="action-buttons">
            ${renderActionButtons(data)}
          </div>

          ${data.status === 'trial' ? `
            <div class="info-card">
              <h4>About Your Trial</h4>
              <p>You're currently on a 10-day free trial. Subscribe before your trial ends to continue enjoying
              unlimited access to all live sports coverage. Your card won't be charged until your trial period expires.</p>
            </div>
          ` : ''}

          ${data.status === 'active' && data.hasStripeCustomer ? `
            <div class="info-card">
              <h4>Manage Your Subscription</h4>
              <p>Use the "Manage Billing" button to update your payment method, view invoices, or cancel your subscription.
              You'll be redirected to our secure billing portal powered by Stripe.</p>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderActionButtons(data) {
      if (data.status === 'active' && data.hasStripeCustomer) {
        return `
          <button class="action-btn secondary" onclick="openPortal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="16" rx="2"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            Manage Billing
          </button>
          <a href="/" class="action-btn primary">Continue to App</a>
        `;
      } else if (data.status === 'trial' || data.status === 'expired' || data.status === 'canceled') {
        return `
          <a href="/pricing" class="action-btn primary">
            ${data.status === 'trial' ? 'Subscribe Now' : 'Reactivate Subscription'}
          </a>
          <a href="/" class="action-btn secondary">Continue to App</a>
        `;
      }
      return `<a href="/" class="action-btn primary">Continue to App</a>`;
    }

    async function openPortal() {
      const btn = event.target.closest('button');
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;margin-right:8px;"></span>Loading...';

      try {
        const response = await fetch('/api/subscription/portal', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to open billing portal');
        }

        window.location.href = data.url;
      } catch (error) {
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      }
    }

    // Check authentication
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/check');
        if (!response.ok) {
          window.location.href = '/login';
        }
      } catch (error) {
        window.location.href = '/login';
      }
    }

    checkAuth();
    loadSubscription();
  </script>
</body>
</html>

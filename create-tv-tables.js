require('dotenv').config();
const { Pool } = require('pg');

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: {
    rejectUnauthorized: false
  }
});

async function createTVTables() {
  console.log('üöÄ Creating TV authentication tables in Supabase...\n');

  try {
    // Create tv_auth_tokens table
    console.log('Creating tv_auth_tokens table...');
    await pool.query(`
      CREATE TABLE IF NOT EXISTS tv_auth_tokens (
        id SERIAL PRIMARY KEY,
        token VARCHAR(64) UNIQUE NOT NULL,
        device_id VARCHAR(64) NOT NULL,
        device_name VARCHAR(100) DEFAULT 'TV Receiver',
        user_id INT REFERENCES users(id) ON DELETE CASCADE,
        status VARCHAR(20) DEFAULT 'pending',
        socket_id VARCHAR(100),
        expires_at TIMESTAMP NOT NULL,
        approved_at TIMESTAMP,
        created_at TIMESTAMP DEFAULT NOW()
      );

      CREATE INDEX IF NOT EXISTS idx_tv_auth_token ON tv_auth_tokens(token);
      CREATE INDEX IF NOT EXISTS idx_tv_auth_device ON tv_auth_tokens(device_id);
      CREATE INDEX IF NOT EXISTS idx_tv_auth_status ON tv_auth_tokens(status);
      CREATE INDEX IF NOT EXISTS idx_tv_auth_expires ON tv_auth_tokens(expires_at);

      COMMENT ON TABLE tv_auth_tokens IS 'Stores temporary QR code tokens for TV authentication';
      COMMENT ON COLUMN tv_auth_tokens.token IS 'Secure 32-byte random token displayed in QR code';
      COMMENT ON COLUMN tv_auth_tokens.device_id IS 'Unique identifier generated by TV app stored in localStorage';
      COMMENT ON COLUMN tv_auth_tokens.status IS 'Token status: pending, approved, expired, used';
      COMMENT ON COLUMN tv_auth_tokens.socket_id IS 'Socket.IO connection ID for real-time auth notification';
    `);
    console.log('‚úÖ tv_auth_tokens table created');

    // Create tv_sessions table
    console.log('Creating tv_sessions table...');
    await pool.query(`
      CREATE TABLE IF NOT EXISTS tv_sessions (
        id SERIAL PRIMARY KEY,
        device_id VARCHAR(64) UNIQUE NOT NULL,
        user_id INT REFERENCES users(id) ON DELETE CASCADE,
        device_name VARCHAR(100) DEFAULT 'TV Receiver',
        session_token VARCHAR(128) UNIQUE NOT NULL,
        is_active BOOLEAN DEFAULT TRUE,
        last_seen_at TIMESTAMP DEFAULT NOW(),
        created_at TIMESTAMP DEFAULT NOW(),
        expires_at TIMESTAMP
      );

      CREATE INDEX IF NOT EXISTS idx_tv_sessions_device ON tv_sessions(device_id);
      CREATE INDEX IF NOT EXISTS idx_tv_sessions_user ON tv_sessions(user_id);
      CREATE INDEX IF NOT EXISTS idx_tv_sessions_token ON tv_sessions(session_token);
      CREATE INDEX IF NOT EXISTS idx_tv_sessions_active ON tv_sessions(is_active);

      COMMENT ON TABLE tv_sessions IS 'Stores persistent authenticated TV sessions';
      COMMENT ON COLUMN tv_sessions.device_id IS 'Unique identifier for the TV device (from localStorage)';
      COMMENT ON COLUMN tv_sessions.session_token IS 'Long-lived session token stored in TV localStorage';
      COMMENT ON COLUMN tv_sessions.is_active IS 'Whether the session is currently active';
    `);
    console.log('‚úÖ tv_sessions table created');

    console.log('\nüéâ TV authentication tables created successfully!');

  } catch (error) {
    console.error('‚ùå Error creating tables:', error.message);
    console.error('Stack:', error.stack);
  } finally {
    await pool.end();
  }
}

createTVTables();
